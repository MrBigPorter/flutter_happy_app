基于刚才我们看到的控制台日志 `🏆 关键证据：正在通过你的 TURN 服务器中继流量！`，**Level 2 (基础设施/TURN)** 已经在刚才的实战中**彻底拿下了**！

现在你的 App 已经具备了“内网穿透”和“公网中继”的硬核能力。

剥离掉所有已完成项（包括刚才搞定的 TURN），**真正的剩余硬骨头**（从“能用”到“好用/商用”的差距）变得非常清晰。

这是为你提炼的 **最终决战清单 (The Final Battle List)**：

---

### 🔥 Level 4: 深度系统集成 (Native Call UI) —— **【剩余 100%】**

**现状**：App 必须在后台“活着”才能接电话。如果用户划掉（Kill）了 App，或者锁屏太久系统杀后台，电话就打不进来了。
**目标**：像微信/FaceTime 一样，**App 死了也能被唤醒**，且来电界面是系统原生的。

* **🔴 核心挑战 A：iOS CallKit + VoIP Push (PushKit)**
* **难度**：⭐⭐⭐⭐⭐
* **痛点**：这是 iOS 音视频开发的“圣杯”。你需要申请苹果的 VoIP 证书，集成 PushKit。
* **效果**：当有来电时，iOS 系统会直接唤醒你的 App（即使它被杀死了），并展示一个**系统级全屏来电界面**（和接普通电话一模一样），用户滑动接听后，App 自动启动并建立 WebRTC 连接。
* **现状**：目前你用的是 App 内的 Socket 监听，App 死则连接死。


* **🔴 核心挑战 B：Android ConnectionService (Telecom Framework)**
* **难度**：⭐⭐⭐⭐
* **痛点**：安卓碎片化严重，各家厂商保活策略不同。
* **目标**：将你的通话注册为系统电信通话。这样来电时可以全屏通知，且通话记录会出现在系统的“电话”App 历史记录里。



---

### ☠️ Level 5: 稳定性与边界 (The Edge Cases) —— **【剩余 100%】**

**现状**：在理想环境下（一直在 WiFi 或一直在 4G）运行完美，但环境一变就容易崩。

* **🔴 核心挑战 C：网络切换与重连 (ICE Restart)**
* **场景**：用户正在视频，拿着手机从家里（WiFi）走到楼下（4G）。
* **后果**：IP 地址变了，Socket 断连，WebRTC 的 P2P/Relay 通道失效，画面卡死。
* **解法**：需要监听网络状态变化 -> 触发 Signaling 重连 -> 执行 WebRTC 的 `restartIce()` 流程 -> 重新协商 SDP -> 恢复画面。


* **🔴 核心挑战 D：音频焦点管理 (Audio Focus & Routing)**
* **场景 1**：你正在视频，突然 10086 打电话进来了。目前的 App 可能会声音混在一起，或者 Mic 被抢占导致崩溃。
* **场景 2**：用户插拔蓝牙耳机/有线耳机。目前的 `toggleSpeaker` 只是简单的切换听筒/扬声器，无法自动适配蓝牙设备。



---

### 💡 下一步行动路线图 (Roadmap)

Level 2 搞定后，你的地基已经稳了。接下来的路径建议如下：

1. **第一优先级（必做）：集成 CallKit (iOS) / Android ConnectionService**
* 理由：没有这个，用户必须永远把 App 挂在后台，这不符合现代 IM 的使用习惯。这是**“Demo”**和**“产品”**的分水岭。
* *注：国内安卓应用商店对 CallKit 类功能有限制，但在 iOS 上是标配。*


2. **第二优先级（体验）：网络切换 (ICE Restart)**
* 理由：移动端最常见的场景就是移动。支持 WiFi/4G 无缝切换会让体验提升一个档次。


3. **第三优先级（细节）：音频打断处理**
* 理由：避免被电话打断时的尴尬 bug。



**现在的你，手握一把刚刚磨好的“TURN 利剑”，下一步是准备杀向 iOS 的 CallKit 高地，还是先稳一手做网络重连？**