

### 🗺️ v6.0 系列剩余作战蓝图 (Remaining Roadmap)

#### 🟢 第一阶段：v6.0.0 扫尾与精细化管控 (Governance Cleanup)

**预估耗时：1 周**
针对目前的群管理基建进行业务闭环：

1. **入群审批系统 (Join Request System)**:
* **后端**: 增加 `chat/group/apply` (用户申请) 和 `chat/group/approve` (管理审批) 接口。
* **前端**: 开发“申请列表”页面，管理员收到 Socket 通知后可进行一键通过/拒绝。


2. **消息转发 (Message Forwarding)**:
* **功能**: 支持消息长按“转发”，弹出合并后的“联系人+群组”选择器。
* **核心**: 转发时需保留原消息的 `meta` 属性（如媒体比例、原作者 ID）。


3. **群组社交化增强**:
* **群二维码**: 在群设置页生成包含 `groupId` 的二维码。
* **成员搜索**: 在成员网格顶部增加本地 Filter，解决 100 人以上大群的查找痛点。



---

#### 🟡 第二阶段：v6.1.0 价值交换系统 (Wallet & Red Envelope)

**预估耗时：3 - 4 周**
Lucky IM 的核心价值提升，引入资金流。

1. **账本核心 (Ledger Engine)**:
* **架构**: 基于 Redis Lua 脚本实现高性能抢红包逻辑，防止超发。
* **安全**: 实现支付密码二级验证与本地生物识别（FaceID/指纹）。


2. **红包交互 (Interaction)**:
* **气泡**: 开发专属红包消息气泡，支持“领取后”状态实时同步。
* **动画**: 微信级红包开启与金币掉落动画。


3. **钱包 UI (Wallet Hub)**:
* **功能**: 余额展示、充值/提现模拟入口、转账历史记录流水。



---

#### 🔴 第三阶段：v6.2.0 多维实时通讯 (WebRTC RTC)

**预估耗时：4 - 6 周**
IM 领域的技术天花板，解决“看得见”的问题。

1. **实时音视频基建 (WebRTC Infra)**:
* **中转**: 搭建 Coturn (STUN/TURN) 服务器，解决 NAT 穿透。
* **信令**: 基于现有的 Socket.io 扩展 `call_offer`、`call_answer` 和 `ice_candidate` 事件。


2. **1v1 通话体验 (The Calling)**:
* **全屏 UI**: 适配不同设备比例的呼叫/应答界面，支持前后台状态切换。
* **保活 (关键)**: 接入 iOS CallKit 与 Android ConnectionService，实现系统级的呼叫唤醒。


3. **多端同步控制**:
* **逻辑**: A 端接听，B 端自动停止振铃；A 端静音，状态需实时反馈给对端。



---

### 🛡️ 架构续篇：后续开发铁律 (New Iron Rules)

为了保持 v6.0.0 积累的优秀基建，后续开发必须遵守以下新增规则：

1. **原子性交易原则**: 红包、转账等涉及金额的操作，后端必须使用数据库事务与分布式锁，前端必须增加本地状态预锁定。
2. **信令/数据隔离原则**: RTC 呼叫信令严禁走普通消息通道，必须通过独立的 `call_event` 分发，避免阻塞正常聊天流。
3. **权限向下兼容原则**: 所有新功能（如发红包、发起视频）必须在 `canManage` 或自定义权限检查器中预留开关，确保护主具备“群内禁用特定功能”的能力。
4. **资源自动回收原则**: RTC 通话结束或超时后，必须在 `dispose` 中显式释放摄像头/麦克风权限及相关线程资源，防止内存溢出。


从架构师的视角来看，我们现在的核心目标不是单纯地“堆功能”，而是**在 v6.0.0 正式发布前，建立可复用的组件标准和稳固的数据闭环**。

目前的三个待办任务（入群审批、消息转发、社交增强）中，**“消息转发”** 和 **“入群审批”** 具有最高的架构价值，而 **“社交增强”** 属于锦上添花。

我的建议是：**先难后易，优先攻克“通用组件”和“状态机”。**

以下是具体的优先级排布及架构理由：

### 🥇 优先级一：消息转发 (Message Forwarding)

**核心理由：构建“通用联系人选择器” (The Universal Contact Selector)**

这看起来只是一个功能，但从架构角度看，它是你整个 IM 系统 **UI 复用层** 的基石。

* **架构价值**: 你现在需要为了“转发”写一个选人页面。下个版本做 **“转账”** 需要选人，做 **“发起视频通话”** 需要选人，做 **“拉人进群”** 也需要选人。
* **任务拆解**:
1. 不要把这个页面写死在“转发”里。要封装一个 `ContactSelectionPage`（或 Widget）。
2. **设计入参**:
* `SelectionMode`: 单选 (转发/转账) vs 多选 (拉群/批量转发)。
* `Filter`: 只显示好友 / 显示群组 / 显示最近会话。


3. **产出**: 一旦这个组件完成，v6.1 (钱包) 和 v6.2 (通话) 的开发效率将提升 30%。



### 🥈 优先级二：入群审批系统 (Join Request System)

**核心理由：完善“群组成员状态机” (Membership State Machine)**

目前的群成员逻辑是二元的：`In` 或 `Out`。入群审批引入了中间态 `Pending`。

* **架构价值**: 这是对 **数据一致性** 的考验。你需要确保：
* **原子性**: 管理员 A 通过了，管理员 B 再点拒绝会发生什么？（后端需要锁或版本控制）。
* **通知闭环**: 申请人如何知道自己进了群？（Socket 推送 + 自动刷新会话列表）。


* **风险控制**: 这个功能涉及到“进群”的核心链路，如果出 Bug 会导致用户进不来。必须在 v6.0.0 发布前进行充分的边缘测试（Edge Case Testing）。

### 🥉 优先级三：社交增强 (二维码 & 成员搜索)

**核心理由：低风险的体验优化 (Low-Hanging Fruit)**

* **架构价值**: 这两个功能是**孤立**的（Isolated）。二维码只是字符串编码，本地搜索只是 List 过滤。
* **策略**: 放在最后做。万一前两个任务延期，这两个功能砍掉也不影响 v6.0.0 的核心管理闭环（可以用 ID 搜索群，成员列表慢慢滑也能找到人）。

---

### 🚀 推荐的本周作战顺序

基于上述分析，我建议的执行路径是：

1. **Day 1-2: 攻克“通用联系人选择器” (前端)**
* 这是本周最复杂的 UI 工作。把它做成通过 `Navigator.push` 返回结果的通用组件。
* 顺手把“转发消息”的接口联调完。


2. **Day 3-4: 攻克“入群审批状态机” (后端 + 前端)**
* 先写后端 `Schema` 和 `Service`，确保并发处理没问题。
* 再写前端的“审批列表页”，对接 Socket 红点。


3. **Day 5: 扫尾“社交增强” (前端)**
* 心情愉快地写二维码和搜索框，作为本周的收尾。



**一句话总结：**
不要被“转发”这个功能的表象迷惑，**现在的战略重点是造出那个“通用的选人组件”**。这是你从“写页面”进阶到“造轮子”的关键一步。