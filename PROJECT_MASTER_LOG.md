# ğŸ›ï¸ Lucky IM Project Master Log v3.0 (The "Empire Foundation" Edition)

> **ğŸ”´ çŠ¶æ€æ ¡å‡† (2026-01-25 22:30)**
> **é‡Œç¨‹ç¢‘è¾¾æˆï¼šIM æ ¸å¿ƒä¸‰ä»¶å¥—å…¨é“¾è·¯é—­ç¯ & ç¦»çº¿è‡ªæ„ˆç³»ç»Ÿ**
> æˆ‘ä»¬å½»åº•æ”»å…‹äº†æ–‡æœ¬ã€å›¾ç‰‡ã€è¯­éŸ³çš„ã€å‘é€-å­˜å‚¨-å±•ç¤º-é‡å‘ã€‘å…¨æµç¨‹ã€‚ç³»ç»Ÿå…·å¤‡äº†å•†ä¸šçº§çš„ç‰©ç†ç¨³å®šæ€§ï¼ˆé˜²è·¯å¾„å¤±æ•ˆï¼‰ã€æ•°æ®å®‰å…¨æ€§ï¼ˆé˜²è¦†ç›–ï¼‰å’Œç½‘ç»œè‡ªæ„ˆèƒ½åŠ›ï¼ˆç¦»çº¿é˜Ÿåˆ—ï¼‰ã€‚
> **ğŸŸ¢ å½“å‰ç‰ˆæœ¬ï¼šv3.0 (Stable Foundation)**

---

## 1. ğŸ›¡ï¸ æ¶æ„é“å¾‹ (The Iron Rules - 9 Commandments)
> **è¿™æ˜¯æˆ‘ä»¬çš„åº•çº¿ï¼Œä»»ä½•åç»­å¼€å‘ä¸¥ç¦è§¦çŠ¯ã€‚**

1.  **ID å”¯ä¸€æ€§**: å‰ç«¯ç”Ÿæˆ UUIDï¼Œåç«¯é€ä¼ ï¼Œç»ä¸ä¾èµ–åç«¯ç”Ÿæˆ IDã€‚
2.  **UI é›¶æŠ–åŠ¨**: ä¸¥ç¦åˆ æ—§æ’æ–°ï¼Œå¿…é¡»ä½¿ç”¨ `update` æ“ä½œï¼Œç¡®ä¿å‘é€è¿‡ç¨‹ä¸­ UI ç»å¯¹é™æ­¢ã€‚
3.  **å•å‘æ•°æ®æµ**: UI åªå¬ DBï¼Œç”¨æˆ·äº¤äº’åªæ”¹ DBï¼Œä¸¥ç¦ UI ç›´æ¥æ“ä½œå†…å­˜åˆ—è¡¨ã€‚
4.  **æ¶ˆæ¯å¹‚ç­‰æ€§**: å®¢æˆ·ç«¯å¿…é¡»å…·å¤‡å¤„ç†é‡å¤æ¶ˆæ¯çš„èƒ½åŠ›ï¼ŒåŒä¸€ ID åªå¤„ç†ä¸€æ¬¡ã€‚
5.  **å­˜å‚¨ç›¸å¯¹åŒ– (iOS/Voice)**: **(å…³é”®)** å›¾ç‰‡å’Œè¯­éŸ³ä¸¥ç¦å­˜ iOS ç»å¯¹è·¯å¾„ï¼Œä»…å­˜æ–‡ä»¶åï¼Œè¿è¡Œæ—¶åŠ¨æ€æ‹¼æ¥ï¼ˆé˜²æ²™ç›’å˜åŠ¨ï¼‰ã€‚
6.  **æœ¬åœ°å­—æ®µä¿æŠ¤**: `saveMessage` å¿…é¡»æ‰§è¡Œ `Read -> Merge -> Write`ã€‚å¦‚æœæ–°æ•°æ®ç¼ºå­—æ®µï¼ˆå¦‚ `previewBytes`ï¼‰ï¼Œå¿…é¡»å¼ºåˆ¶ä¿ç•™æ—§æ•°æ®çš„å­—æ®µï¼Œä¸¥ç¦ç›´æ¥è¦†ç›–ã€‚
7.  **Web ä¾èµ–é”æ­»**: `pubspec.yaml` é”å®š `idb_shim: ^2.6.0`ï¼Œé˜²æ­¢ `KeyRange` å´©æºƒã€‚
8.  **æé€Ÿé¢„è§ˆä¼˜å…ˆ**: ä»»ä½•å›¾ç‰‡æ¸²æŸ“éµå¾ª `MemoryBytes` > `LocalFile` > `Network` çš„ä¼˜å…ˆçº§ï¼Œç¡®ä¿ 0 ç­‰å¾…æ‰“å¼€ã€‚
9.  **Web å½•éŸ³é€‚é…**: Web ç«¯é‡‡ç”¨â€œç‚¹å‡»åˆ‡æ¢â€æ¨¡å¼ï¼ŒMobile ç«¯â€œé•¿æŒ‰â€æ¨¡å¼ï¼›æ’­æ”¾å‰å¿…é¡»æ¸…æ´— iOS çš„ `file://` å‰ç¼€ã€‚

---

## 2. ğŸ—ºï¸ ä»£ç åœ°å›¾ (Code Map)

### A. æ•°æ®å±‚ (Database) - `local_database_service.dart`
* **Smart Merge**: æ™ºèƒ½åˆå¹¶é€»è¾‘ï¼Œå®ˆæŠ¤æœ¬åœ° `previewBytes` å’Œ `localPath` ä¸è¢« Socket å›åŒ…æ¸…æ´—ã€‚

### B. å…¨å±€ç›‘å¬å±‚ (Global) - `conversation_provider.dart`
* **çº¢ç‚¹äº’æ–¥**: å¼•å…¥ `isViewingNow`ï¼Œç¡®ä¿æŸ¥çœ‹æˆ¿é—´æ—¶åˆ—è¡¨é¡µçº¢ç‚¹ä¸å¢åŠ ã€‚
* **å®æ—¶ç½®é¡¶**: å‘é€æ¶ˆæ¯ç¬é—´è°ƒç”¨ `updateLocalItem`ï¼Œç½®é¡¶ä¼šè¯å¹¶æ¸…ç©ºçº¢ç‚¹ã€‚

### C. èŠå¤©å®¤æ§åˆ¶å±‚ (Controller) - `chat_room_controller.dart`
* **è¯­éŸ³æµç¨‹**: `Pre-process` -> `Move to chat_audio` -> `Save Relative Path`ã€‚
* **å›¾ç‰‡æµç¨‹**: å¹¶å‘æ‰§è¡Œ `ImageCompression` (ç”Ÿæˆå¾®ç¼©å›¾) + `File Move` (ç‰©ç†è½æˆ·)ã€‚
* **é›¶æŠ–åŠ¨ç¼“å­˜**: é™æ€ `_sessionPathCache` å­˜å‚¨ç»å¯¹è·¯å¾„ï¼Œç¡®ä¿å‘é€ç¬é—´ç§’å¼€ã€‚

### D. ç¦»çº¿é˜Ÿåˆ— (Queue) - `offline_queue_manager.dart`
* **æœºåˆ¶**: Outbox Pattern (å‘ä»¶ç®±æ¨¡å¼)ã€‚
* **è‡ªæ„ˆ**: ç½‘ç»œæ¢å¤ + App å‰å°æ¢å¤ (`resumed`) åŒé‡è§¦å‘ flushã€‚
* **è·¯å¾„é‡ç»„**: æ ¹æ® DB ç›¸å¯¹è·¯å¾„åŠ¨æ€é‡å»ºç»å¯¹è·¯å¾„ï¼Œé˜²æ­¢é‡å¯åé‡å‘å¤±è´¥ã€‚

### E. åª’ä½“æœåŠ¡ (Media Services)
* **`image_compression_service.dart`**: Mobile (Isolate) + Web (Canvas ç¡¬ä»¶åŠ é€Ÿ)ã€‚
* **`voice_recorder_service.dart`**: Web Blob å…¼å®¹ + Mobile è·¯å¾„ç®¡ç†ã€‚
* **`audio_player_manager.dart`**: è‡ªåŠ¨æ¸…æ´— iOS `file://` åè®®å¤´ã€‚

---

## 3. ğŸ† å…¨é‡æˆ˜æœæ¸…å• (The Trophy Case)

#### ğŸ¥‡ [æ ¸å¿ƒ] è¯­éŸ³/å›¾ç‰‡æ¶ˆæ¯çš„â€œæ°¸ä¹…å±…ä½è¯â€
* **æ”»å…‹**: ç¡®è®¤å‘é€æ—¶å°†æ–‡ä»¶ `copy` åˆ°æŒä¹…åŒ–ç›®å½• (`chat_audio`/`chat_images`)ï¼ŒDB ä»…å­˜æ–‡ä»¶åã€‚
* **ä¿®å¤**: è§£å†³äº† iOS é‡å¯åæ–‡ä»¶ä¸¢å¤±ã€æ’­æ”¾è·¯å¾„å¸¦åè®®å¤´å´©æºƒçš„é—®é¢˜ã€‚

#### ğŸ¥ˆ [æ ¸å¿ƒ] ç¦»çº¿é‡å‘ç³»ç»Ÿçš„â€œè‡ªæˆ‘ä¿®å¤â€
* **æ”»å…‹**: `OfflineQueueManager` å®ç°äº†å®Œç¾çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ŒApp æ€è¿›ç¨‹åé‡å¯ä¾ç„¶èƒ½è‡ªåŠ¨æ‰«æå¹¶é‡å‘ Pending æ¶ˆæ¯ã€‚

#### ğŸ¥‰ [æ ¸å¿ƒ] è·¨å¹³å°æè‡´å‹ç¼©
* **æ”»å…‹**: Web ç«¯åˆ©ç”¨ Canvas å°†å›¾ç‰‡å‹è‡³ <50KB å­˜å…¥ IndexedDBï¼Œå®ç°äº† Web åˆ·æ–°åçš„â€œç§’å¼€â€ä½“éªŒã€‚

#### ğŸ… [ä½“éªŒ] ä¼šè¯åˆ—è¡¨çš„â€œçº¢ç‚¹é˜²å¾¡â€
* **æ”»å…‹**: å¼•å…¥ `activeConversationId`ï¼Œåœ¨æˆ¿é—´å†…é˜…è¯»æ—¶ï¼Œå¤–éƒ¨çº¢ç‚¹å®æ—¶åŒæ­¥ï¼ˆä¸å¢åŠ ï¼‰ã€‚

#### ğŸ… [æ¶æ„] æ•°æ®åº“é˜²è¦†ç›–
* **æ”»å…‹**: Socket æ¥æ”¶æ—¶å…ˆæŸ¥æœ¬åœ° `previewBytes` å¹¶æ³¨å…¥æ–° Modelï¼Œå½»åº•è§£å†³â€œå›¾ç‰‡å‘é€æˆåŠŸå˜ç™½â€çš„é—®é¢˜ã€‚

---

## 4. âœ… å·²å®Œç»“åŠŸèƒ½ (Checklist)

* [x] **[P0] è¯­éŸ³æ¶ˆæ¯å…¨é“¾è·¯** (å½•éŸ³äº¤äº’/ç›¸å¯¹è·¯å¾„/æ’­æ”¾æ¸…æ´—)ã€‚
* [x] **[P0] æ–­ç½‘é‡å‘ç³»ç»Ÿ** (é˜Ÿåˆ—/ç”Ÿå‘½å‘¨æœŸ/è·¯å¾„é‡ç»„)ã€‚
* [x] **[P1] è·¨å¹³å°æè‡´å‹ç¼©** (Isolate + Canvas)ã€‚
* [x] **[P1] ä¼šè¯åˆ—è¡¨çŠ¶æ€å¯¹é½** (çº¢ç‚¹äº’æ–¥/å‘é€ç½®é¡¶)ã€‚
* [x] **Web ç«¯å¾®ç¼©å›¾æŒä¹…åŒ–** (PreviewBytes)ã€‚
* [x] **å›¾ç‰‡æ°”æ³¡è‡ªé€‚åº”** (å®½é«˜è®¡ç®—) & **å…¨å±ç§’å¼€** (å¾®ç¼©å›¾å ä½)ã€‚