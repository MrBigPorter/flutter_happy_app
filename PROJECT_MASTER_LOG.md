
**Master Log å¿…é¡»æ˜¯å…¨é‡çš„**ï¼Œæ˜¯ä» v2.1 åˆ° v2.5 æ‰€æœ‰å¿ƒè¡€çš„ç»“æ™¶ï¼Œ**ä¸€æ¡éƒ½ä¸èƒ½å°‘**ã€‚

è¿™æ˜¯**çœŸæ­£çš„ã€å®Œå…¨ä½“çš„ Project Master Log v2.5**ï¼ŒåŒ…å«äº†æˆ‘ä»¬ä»æœ€æ—©åˆ°ç°åœ¨æ”»å…‹çš„æ‰€æœ‰éš¾é¢˜ã€‚è¿™æ¬¡ç»å¯¹ä¸ç¼©æ°´ï¼

---

# ğŸ›ï¸ Lucky IM Project Master Log v2.5 (The "Grand Unified" Edition)

> **ğŸ”´ çŠ¶æ€æ ¡å‡† (2026-01-25 21:15)**
> **é‡Œç¨‹ç¢‘è¾¾æˆï¼šç‰©ç†å­˜å‚¨ç¨³å®šæ€§ã€æ¸²æŸ“å®‰å…¨ä¸ Web ç«¯æè‡´ä½“éªŒ**
> æˆ‘ä»¬å½»åº•è§£å†³äº†ä»â€œè·¯å¾„å¤±æ•ˆâ€åˆ°â€œWeb ä¾èµ–å†²çªâ€å†åˆ°â€œæ•°æ®è¦†ç›–â€çš„æ‰€æœ‰é¡½ç–¾ã€‚Lucky IM ç°åœ¨æ˜¯ä¸€ä¸ªå¤šç«¯ä¸€è‡´ã€ç‰©ç†ç¨³å›ºã€ä½“éªŒä¸æ»‘çš„ç³»ç»Ÿã€‚
> **ğŸŸ¢ å½“å‰é˜¶æ®µï¼šv3.0 ä½“éªŒçªå›´**
> **ç›®æ ‡**ï¼šæ¨è¿›è¯­éŸ³æ¶ˆæ¯ç›¸å¯¹è·¯å¾„å¯¹é½ï¼Œå‘ v3.0 è¿ˆè¿›ã€‚

---

## 1. ğŸ›¡ï¸ æ¶æ„é“å¾‹ (The Iron Rules - 8 Commandments)

> **è¿™æ˜¯æˆ‘ä»¬çš„åº•çº¿ï¼Œä»»ä½•åç»­å¼€å‘ä¸¥ç¦è§¦çŠ¯ã€‚**

1. **ID å”¯ä¸€æ€§**: å‰ç«¯ç”Ÿæˆ UUIDï¼Œåç«¯é€ä¼ ï¼Œç»ä¸ä¾èµ–åç«¯ç”Ÿæˆ IDã€‚
2. **UI é›¶æŠ–åŠ¨**: ä¸¥ç¦åˆ æ—§æ’æ–°ï¼Œå¿…é¡»ä½¿ç”¨ `update` æ“ä½œï¼Œç¡®ä¿å‘é€è¿‡ç¨‹ä¸­ UI ç»å¯¹é™æ­¢ã€‚
3. **å•å‘æ•°æ®æµ**: UI åªå¬ DBï¼Œç”¨æˆ·äº¤äº’åªæ”¹ DBï¼Œä¸¥ç¦ UI ç›´æ¥æ“ä½œå†…å­˜åˆ—è¡¨ã€‚
4. **æ¶ˆæ¯å¹‚ç­‰æ€§**: å®¢æˆ·ç«¯å¿…é¡»å…·å¤‡å¤„ç†é‡å¤æ¶ˆæ¯çš„èƒ½åŠ›ï¼ŒåŒä¸€ ID åªå¤„ç†ä¸€æ¬¡ã€‚
5. **å­˜å‚¨ç›¸å¯¹åŒ– (iOS)**: æ•°æ®åº“ä¸¥ç¦å­˜ iOS ç»å¯¹è·¯å¾„ï¼Œä»…å­˜æ–‡ä»¶åï¼Œè¿è¡Œæ—¶åŠ¨æ€æ‹¼æ¥ï¼ˆé˜²æ²™ç›’å˜åŠ¨ï¼‰ã€‚
6. **æœ¬åœ°å­—æ®µä¿æŠ¤ (New)**: `saveMessage` å¿…é¡»æ‰§è¡Œ `Read -> Merge -> Write`ã€‚å¦‚æœæ–°æ•°æ®ç¼ºå­—æ®µï¼ˆå¦‚ `previewBytes`ï¼‰ï¼Œå¿…é¡»å¼ºåˆ¶ä¿ç•™æ—§æ•°æ®çš„å­—æ®µï¼Œä¸¥ç¦ç›´æ¥è¦†ç›–ã€‚
7. **Web ä¾èµ–é”æ­» (New)**: `pubspec.yaml` å¿…é¡»ä½¿ç”¨ `dependency_overrides` é”å®š `idb_shim: ^2.6.0` å’Œ `sembast_web: ^2.3.2`ï¼Œé˜²æ­¢ `LegacyJavaScriptObject` å´©æºƒã€‚
8. **æé€Ÿé¢„è§ˆä¼˜å…ˆ (New)**: ä»»ä½•å›¾ç‰‡æ¸²æŸ“ï¼Œå¿…é¡»éµå¾ª `MemoryBytes (previewBytes)` > `LocalFile` > `Network` çš„ä¼˜å…ˆçº§ï¼Œç¡®ä¿ 0 ç­‰å¾…æ‰“å¼€ã€‚

---

## 2. ğŸ—ºï¸ ä»£ç åœ°å›¾ (Code Map)

### A. æ•°æ®å±‚ (Database) - `local_database_service.dart`

* **æœºåˆ¶**: Sembast (NoSQL) / Web ä¾§ IndexedDBã€‚
* **é€»è¾‘**: æ¥æ”¶æ‰€æœ‰æ•°æ®æ›´æ–°ã€‚
* **æ ¸å¿ƒå‡çº§**: å®ç°äº† **Smart Merge (æ™ºèƒ½åˆå¹¶)** é€»è¾‘ï¼Œå®ˆæŠ¤æœ¬åœ°ç‰¹æœ‰æ•°æ®ï¼ˆLocal Path / Bytesï¼‰ã€‚

### B. å…¨å±€ç›‘å¬å±‚ (Global Listener) - `conversation_provider.dart`

* **é€»è¾‘**: ç›‘å¬ Socket -> å¼ºåˆ¶å­˜åº“ -> ç»“åˆ ActiveID äº’æ–¥æ›´æ–°çº¢ç‚¹ã€‚

### C. èŠå¤©å®¤æ§åˆ¶å±‚ (Room Controller) - `chat_room_controller.dart`

* **å»é‡**: `Set<String> _processedMsgIds` æ‹¦æˆªåŒé‡å¹¿æ’­ã€‚
* **ç”Ÿå‘½å‘¨æœŸ**: `WidgetsBindingObserver` ç¡®ä¿ä»…åœ¨å‰å°å‘é€å›æ‰§ã€‚
* **é›¶æŠ–åŠ¨ç¼“å­˜**: é™æ€ `_sessionPathCache` å­˜å‚¨ç»å¯¹è·¯å¾„ï¼Œç¡®ä¿å‘é€ç¬é—´ç§’å¼€ã€‚
* **Socket å¤„ç†**: æ¥æ”¶æ¶ˆæ¯æ—¶ï¼Œå…ˆè¯»å–æœ¬åœ° DBï¼Œå°†æœ¬åœ° Bytes æ³¨å…¥åˆ°æ–° Model ä¸­å†ä¿å­˜ã€‚

### D. UI å±‚ (ChatPage & Bubble) - `chat_bubble.dart`

* **è§†è§‰è¿‡æ»¤**: ä»…åœ¨æœ€æ–°ä¸€æ¡æ˜¾ç¤º "Read"ã€‚
* **æ¸²æŸ“è·¯ç”±**: Stack å±‚çº§ä¼˜åŒ– -> `Network` (åº•å±‚) < `MemoryBytes` (ä¸­å±‚ï¼Œé˜²é—ªçƒæ ¸å¿ƒ) < `LocalFile` (é¡¶å±‚)ã€‚
* **è‡ªé€‚åº”å¸ƒå±€ (New)**: æ‘’å¼ƒæ­£æ–¹å½¢ï¼Œæ ¹æ®å›¾ç‰‡å®½é«˜æ¯”åŠ¨æ€è®¡ç®—æ°”æ³¡å°ºå¯¸ï¼ˆMax 0.65sw / 0.50shï¼‰ã€‚

### E. é¢„è§ˆå±‚ (PhotoPreview) - `photo_preview_page.dart`

* **è§†è§‰å ä½ (New)**: æ¥æ”¶ `previewBytes`ï¼Œå¼ºåˆ¶å…¨å±æ‹‰ä¼¸ (`width: double.infinity`)ï¼Œå®ç°ç‚¹å¼€å³æ˜¾ï¼Œæ— ç¼è¿‡æ¸¡åˆ°é«˜æ¸…å›¾ã€‚

---

## 3. ğŸ† æŠ€æœ¯æ”»åšæˆ˜æŠ¥ (The Trophy Case - Full Collection)

#### ğŸ¥‡ åŒé‡å¹¿æ’­çš„å›å£°æ¶ˆé™¤

* **æ”»å…‹**: åœ¨ Controller å±‚æ„å»ºå³æ—¶å»é‡æ± ï¼Œ100% æ‹¦æˆªåç«¯ Fan-out é€ æˆçš„é‡å¤æ¶ˆæ¯ã€‚

#### ğŸ¥ˆ åƒµå°¸æ§åˆ¶å™¨çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†

* **æ”»å…‹**: å¼•å…¥ `WidgetsBindingObserver`ï¼Œç²¾å‡†æ§åˆ¶ App é€€åå°åçš„å·²è¯»å›æ‰§å‘é€ï¼Œé˜²æ­¢çŠ¶æ€æ¬ºéª—ã€‚

#### ğŸ¥‰ è§†è§‰å·²è¯»çš„æ™ºèƒ½é™å™ª

* **æ”»å…‹**: å¼€å‘â€œå€’åºé”šç‚¹ç®—æ³•â€ï¼Œä»…é”å®šæœ€æ–°ä¸€æ¡å·²è¯»æ¶ˆæ¯ä½œä¸ºè§†è§‰é”šç‚¹ï¼Œæ‹’ç»æ»¡å± "Read"ã€‚

#### ğŸ… é›¶æŠ–åŠ¨å‘é€æ¶æ„

* **æ”»å…‹**: ç¡®ç«‹ Client-ID ä¼˜å…ˆåŸåˆ™ + æ•°æ®åº“ `upsert`ï¼Œå®ç°å‘é€å…¨è¿‡ç¨‹æ°”æ³¡ä¸é—ªçƒã€ä¸è·³åŠ¨ã€‚

#### ğŸ–ï¸ Hero ç»„ä»¶çš„â€œå¥—å¨ƒâ€å°å°

* **æ”»å…‹**: æå– Hero åˆ°æ°”æ³¡æœ€å¤–å±‚ï¼Œå†…éƒ¨å­ç»„ä»¶ä¸å†åŒ…å« Heroï¼Œè§£å†³ Tag å†²çªå¯¼è‡´çš„å´©æºƒã€‚

#### ğŸ–ï¸ iOS æ²™ç›’è·¯å¾„çš„â€œæ°¸ä¹…å±…ä½è¯â€

* **æ”»å…‹**: å®æ–½â€œç›¸å¯¹è·¯å¾„å­˜å‚¨æ–¹æ¡ˆâ€ï¼ŒDB ä»…å­˜æ–‡ä»¶åï¼Œè¿è¡Œæ—¶åŠ¨æ€å¯»å€ï¼Œå½»åº•è§£å†³ iOS é‡å¯åæ–‡ä»¶ä¸¢å¤±é—®é¢˜ã€‚

#### ğŸ–ï¸ æ•°æ®åº“è¦†ç›–çš„â€œé˜²å®ˆåå‡»â€ (New)

* **æ”»å…‹**: è§£å†³æœåŠ¡å™¨å›åŒ…æ¸…æ´—æœ¬åœ°æ•°æ®çš„é—®é¢˜ã€‚é€šè¿‡ DB å±‚çš„æ™ºèƒ½åˆå¹¶ï¼Œè®© `previewBytes` åœ¨æ•°æ®æ›´æ–°ä¸­å­˜æ´»ã€‚

#### ğŸ–ï¸ IndexedDB çš„â€œè·¨ç‰ˆæœ¬æ•‘æ´â€ (New)

* **æ”»å…‹**: é€šè¿‡ `dependency_overrides` å¼ºåˆ¶å‡çº§åº•å±‚ `idb_shim`ï¼Œå½»åº•æ¶ˆç­ Web ç«¯ `KeyRange` ç±»å‹é”™è¯¯ã€‚

#### ğŸ–ï¸ æ°”æ³¡çš„â€œå®Œç¾æ¯”ä¾‹â€ä¸â€œç§’å¼€ä½“éªŒâ€ (New)

* **æ”»å…‹**: å®ç°å›¾ç‰‡æ°”æ³¡è‡ªé€‚åº”å®½é«˜ï¼Œå¹¶åˆ©ç”¨å¾®ç¼©å›¾å¼ºåˆ¶æ‹‰ä¼¸æŠ€æœ¯ï¼Œå®ç° Web ç«¯å›¾ç‰‡æŸ¥çœ‹çš„æè‡´æµç•…ä½“éªŒã€‚

---

## 4. ğŸ”® v3.0 æ ¸å¿ƒåŠŸèƒ½æŠ€æœ¯è§„åˆ’ (Blueprint)

### A. ğŸ‘‘ æ–­ç½‘é‡å‘é˜Ÿåˆ— (Offline Send Queue)

* **æ¨¡å¼**: Outbox Patternã€‚
* **çŠ¶æ€**: æ ¸å¿ƒé€»è¾‘ `OfflineQueueManager` å·²ä¸Šçº¿ï¼Œå¾…ç»“åˆ UI çŠ¶æ€å±•ç¤ºã€‚

### B. ğŸ–¼ï¸ Web åª’ä½“ä½“éªŒå¢å¼º (Web Media Optimization)

* **çŠ¶æ€**: **å·²å®Œæˆ (Done)**ã€‚é€šè¿‡å¾®ç¼©å›¾æŒä¹…åŒ–å’Œä¸‰çº§æ¸²æŸ“ï¼ŒWeb ç«¯ä½“éªŒå·²è¾¾æ ‡ã€‚

---

## 5. âœ… å·²å®Œç»“åŠŸèƒ½ (Checklist)

* [x] **æ–‡æœ¬/è¯­éŸ³/å›¾ç‰‡å…¨é“¾è·¯**ï¼šå‘é€ã€æ¥æ”¶ã€å±•ç¤ºã€æŒä¹…åŒ–ã€‚
* [x] **æ’¤å›ä¸åˆ é™¤**ï¼šåŒç«¯é€»è¾‘åŒæ­¥ã€‚
* [x] **å›¾ç‰‡é¢„å¤„ç†**ï¼šå®½é«˜è®¡ç®—ã€æœ¬åœ°æŒä¹…åŒ–æ‹·è´ã€‚
* [x] **å‘é€é›¶æŠ–åŠ¨** / **çº¢ç‚¹äº’æ–¥é€»è¾‘**ã€‚
* [x] **iOS è·¯å¾„å˜åŠ¨é˜²å¾¡** / **Hero åµŒå¥—æŠ¥é”™ä¿®å¤**ã€‚
* [x] **Web ç«¯æ•°æ®åº“å†™å…¥ä¸è¯»å–ä¿®å¤** (ä¾èµ–è¦†ç›–)ã€‚
* [x] **é˜²æ­¢æœåŠ¡å™¨æ•°æ®è¦†ç›–æœ¬åœ°æ–‡ä»¶** (Smart Merge)ã€‚
* [x] **å›¾ç‰‡æ°”æ³¡è‡ªé€‚åº”å®½é«˜** / **å…¨å±é¢„è§ˆç§’å¼€**ã€‚

---

## 6. ğŸš¦ å¾…åŠä»»åŠ¡ (Next Steps)

1. **[P0] è¯­éŸ³æ¶ˆæ¯ç›¸å¯¹è·¯å¾„å¯¹é½**:
* [ ] æ£€æŸ¥ `VoiceBubble` å’Œ `ChatRoomController`ï¼Œç¡®è®¤éŸ³é¢‘æ–‡ä»¶æ˜¯å¦ä¹Ÿå­˜äº†ç»å¯¹è·¯å¾„ï¼Ÿ
* [ ] å¦‚æœæ˜¯ï¼Œå¿…é¡»ç«‹åˆ»æŒ‰å›¾ç‰‡çš„æ–¹æ¡ˆæ”¹ä¸ºâ€œç›¸å¯¹è·¯å¾„â€ã€‚


2. **[P1] è·¨å¹³å°æè‡´å‹ç¼©å·¥å…·ç±»**:
* [ ] å®Œå–„ `ImageCompressionService`ï¼Œæ”¯æŒ Mobile Isolate ä¸ Web Canvasã€‚



---


