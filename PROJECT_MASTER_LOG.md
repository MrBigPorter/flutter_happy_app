ä¸¥æ ¼ä¿æŒä» **v4.0 åˆ° v5.3.3** çš„æ‰€æœ‰æ–‡å­—ã€æ’ç‰ˆå’Œç»†èŠ‚ä¸åŠ¨ï¼Œ

---

# ğŸ“œ Lucky IM Project **Grand Master Log** (v4.0 - v6.0.0)

> **ğŸ•’ ç»ˆæå°æ¡£**: 2026-02-13 00:45 (PST)
> **ğŸš€ å½“å‰ç‰ˆæœ¬**: **v6.0.0 (The Governance & Authority)**
> **ğŸŒŸ æ€»ä½“è¿›åº¦**: **å…¨æ ˆåŸºå»ºä¸æè‡´ä½“éªŒå®Œå…¨å°é¡¶ï¼Œé«˜çº§ç¾¤æ§ä½“ç³»æ­£å¼å¹¶ç½‘ã€‚**
> æœ¬æ—¥å¿—æ˜¯ Lucky IM çš„æŠ€æœ¯ç¼–å¹´å²ï¼Œå®Œæ•´è®°å½•äº†ä»å•æœº MVP åˆ°å·¥ä¸šçº§åˆ†å¸ƒå¼ IM çš„æ¼”è¿›å†ç¨‹ï¼Œæ¶µç›–äº†ä¸€è‡´æ€§ã€é«˜å¯é æ€§ã€æè‡´åª’ä½“ä½“éªŒã€åç«¯æ¶æ„ã€æ€§èƒ½ä¼˜åŒ–åŠ**å…¨æ–°æƒåŠ›æ²»ç†ä½“ç³»**çš„æ‰€æœ‰å…³é”®èŠ‚ç‚¹ã€‚

---

## ğŸ‘‘ ç¬¬ä¸ƒç« ï¼šæƒåŠ›æ²»ç†ä¸æƒé™é˜²çº¿ (Governance & Authority) **[NEW - v6.0.0]**

*æœ¬ç« æ ‡å¿—ç€ Lucky IM å…·å¤‡äº†å·¥ä¸šçº§ç¤¾ç¾¤ç®¡æ§èƒ½åŠ›ï¼Œé€šè¿‡ RBAC æ¨¡å‹è§£å†³äº†å¤šè§’è‰²å¹¶å‘ä¸‹çš„æƒé™å†²çªã€æç«¯ç«æ€æŠ¥é”™ä¸ UI æ¸²æŸ“å†²çªã€‚*

* **[RBAC] è½»é‡çº§æƒé™çŸ©é˜µ (Authority Matrix)**:
* **æ ¸å¿ƒ**: åŸºäº `OWNER` (ç¾¤ä¸»)ã€`ADMIN` (ç®¡ç†å‘˜)ã€`MEMBER` (æˆå‘˜) çš„ä¸‰çº§æƒé™ä½“ç³»ã€‚
* **åç«¯**: åœ¨ `ChatGroupService` å»ºç«‹ `_checkPermission` å®ˆå«ï¼Œæ‰€æœ‰å†™æ“ä½œï¼ˆè¸¢äººã€ç¦è¨€ã€æ”¹åç­‰ï¼‰æ‰§è¡Œå¼ºåˆ¶è§’è‰²æ ¡éªŒã€‚
* **å‰ç«¯**: æ‰©å±• `ChatMember` æ¨¡å‹ï¼Œå¼•å…¥ `canManage` æƒé™åˆ¤æ–­é€»è¾‘ï¼Œé€šè¿‡ `group_profile_logic.dart` åŠ¨æ€é©±åŠ¨ UI èœå•çš„æ˜¾ç¤ºä¸éšè—ã€‚


* **[Control] å³æ—¶ç®¡æ§æ­¦å™¨åº“ (Group Toolkit)**:
* **ç¦è¨€ç³»ç»Ÿ**: æ”¯æŒå•äººå®šæ—¶ç¦è¨€ (`mutedUntil`) ä¸å…¨å‘˜ç¦è¨€ (`isMuteAll`)ã€‚é€šè¿‡ Socket å®æ—¶åŒæ­¥ä»¤å—é™ç”¨æˆ·çš„è¾“å…¥æ¡†ç¬é—´ç½®ç°ã€‚
* **æˆå‘˜ç®¡æ§**: å®ç°è¸¢äºº (`kick`)ã€è½¬è®©ç¾¤ä¸» (`transferOwner`)ã€å‡é™ç®¡ç†å‘˜ (`setAdmin`) ç­‰æ ¸å¿ƒæŒ‡ä»¤ã€‚
* **å®¡æ‰¹æµ**: å¼•å…¥ `joinNeedApproval` å‡†å…¥å¼€å…³ï¼Œä¸ºåç»­é«˜çº§ç¤¾ç¾¤æ²»ç†æœºåˆ¶å¤¯å®åè®®åŸºç¡€ã€‚


* **[Sync] å¤æ‚äº‹ä»¶å¤„ç†å™¨ (Event Processor)**:
* **é€»è¾‘**: å‰ç«¯ `ChatEventProcessor` å®ç°äº†å¯¹ `member_kicked`ã€`group_disbanded` ç­‰ä¿¡ä»¤äº‹ä»¶çš„å…¨å±€ç›‘å¬ã€‚
* **è‡ªæ„ˆ**: æ”¶åˆ°è¢«è¸¢äº‹ä»¶åï¼Œè‡ªåŠ¨æ‰§è¡Œâ€œæœ¬åœ°åº“æ¸…ç† -> åˆ·æ–°ä¼šè¯åˆ—è¡¨ -> å¼ºåˆ¶é€€æˆ¿è·³è½¬â€çš„ä¸€ç«™å¼è‡ªæ„ˆæµç¨‹ã€‚


* **[Defense] æç«¯ç«æ€é˜²å¾¡ (Race Condition Defense)**:
* **ç°è±¡**: æ”»å…‹äº†ç”¨æˆ·è¢«è¸¢ç¬é—´ï¼Œå› ç³»ç»Ÿæ¶ˆæ¯ (`type 99`) è§¦å‘å·²è¯»ä¸ŠæŠ¥ï¼Œè€Œæ­¤æ—¶æƒé™å·²ä¸¢å¤±å¯¼è‡´çš„ 403 `Bad Response` æŠ¥é”™ã€‚
* **æ‹¦æˆªå™¨**: åœ¨ `ChatEventHandler._onSocketMessage` å¼•å…¥ç³»ç»Ÿæ¶ˆæ¯è¿‡æ»¤ï¼Œæ‹’ç»è®©é€šçŸ¥ç±»æ¶ˆæ¯è§¦å‘å·²è¯»é˜²æŠ–æµã€‚
* **é€»è¾‘é”**: `markAsRead` å‘èµ·ç½‘ç»œè¯·æ±‚å‰å¼ºåˆ¶è°ƒç”¨ `getConversation` æ£€æŸ¥ä¼šè¯æ˜¯å¦å·²è¢«åˆ é™¤ï¼Œå¹¶åœ¨ `catch` å—ä¸­é€šè¿‡ `_isDisposed` é™é»˜å¿½ç•¥é”€æ¯æœŸé—´çš„é”™è¯¯ã€‚
* **UI ç¢°æ’é˜²å¾¡**: ä½¿ç”¨ `addPostFrameCallback` ç»“åˆé”®ç›˜ `unfocus` é€»è¾‘è¿›è¡Œè·¯ç”±è·³è½¬ï¼Œå½»åº•æ¶ˆç­äº†å¹¶å‘ä¿¡ä»¤ä¸‹çš„ `Assertion failed` æ¸²æŸ“å´©æºƒã€‚



---

## ğŸ† ç¬¬ä¸€ç« ï¼šæè‡´è§†è§‰ä¸é»„é‡‘å‚æ•° (The Visual Revolution) **[v5.3.2 - v5.3.3]**

*æœ¬ç« æ”»å…‹äº†ç§»åŠ¨ç«¯æœ€éš¾çš„â€œå›¾ç‰‡åˆ—è¡¨æ€§èƒ½â€ä¸â€œç½‘ç»œç‰©ç†å»¶è¿Ÿâ€ï¼Œå¹¶é€šè¿‡é»„é‡‘å‚æ•°å®ç°äº†åŸç”Ÿçº§ä½“éªŒã€‚*

* **[Tuning] é»„é‡‘å‚æ•°è°ƒä¼˜ (The Golden Parameters)** **[NEW - v5.3.3]**:
* **Preload Window**: **15** (ç»æµé€‚ç”¨å€¼)ã€‚ä»æ¿€è¿›çš„ 30 é™çº§ä¸º 15ï¼Œå¹³è¡¡å¸¦å®½ä¸é¢„çƒ­æ•ˆæœï¼Œæ‹’ç»æ— æ•ˆæµé‡ã€‚
* **Item Height**: **300.0** (ç‰©ç†ä¿®æ­£å€¼)ã€‚ä¿®æ­£é»˜è®¤ 150.0 å¯¼è‡´çš„ç´¢å¼•ä¼°ç®—åå·®ï¼Œå½»åº•æ¶ˆç­â€œé¢„åŠ è½½æ¼å›¾â€ã€‚
* **Look-Back**: **15** (å›çœ‹ç¼“å†²)ã€‚`startIndex = index - 15`ï¼Œå®å¯å¤šç®—ï¼Œä¸å¯æ¼ç®—ã€‚
* **LoadMore Threshold**: **2000** (æ— æ„Ÿé˜ˆå€¼)ã€‚å°†è§¦å‘çº¿ä» 500 æè‡³ 2000ï¼Œå®ç°çœŸæ­£çš„æ— é™æµæ»šåŠ¨ã€‚
* **[Image] è§†è§‰æ¬ºéª—æ¶æ„ (Visual Deception Architecture)** **[NEW - v5.3.2]**:
* **æ ¸å¿ƒ**: æ‰¿è®¤ç½‘ç»œå»¶è¿Ÿï¼Œåˆ©ç”¨æœ¬åœ°æ•°æ®è¡¥å¿è§†è§‰ã€‚
* **å®ç°**: `AppCachedImage` å¼•å…¥ **Stack ç‰©ç†å †å **ã€‚åº•å±‚æ¸²æŸ“ `previewBytes` (æ•°æ®åº“ç¼©ç•¥å›¾)ï¼Œé¡¶å±‚æ¸²æŸ“ç½‘ç»œé«˜æ¸…å›¾ã€‚
* **æ•ˆæœ**: æ— è®ºæ–­ç½‘æˆ–å¼±ç½‘ï¼Œç”¨æˆ·æ°¸è¿œçœ‹ä¸åˆ°ç™½å±æˆ– Loadingï¼Œåªèƒ½çœ‹åˆ°â€œç”±ç³Šå˜æ¸…â€çš„æ— ç¼è¿‡ç¨‹ã€‚
* **[Align] å‚æ•°æŒ‡çº¹å¯¹é½ (Parameter Alignment)** **[NEW - v5.3.2]**:
* **æ–¹æ¡ˆ**: **Bucketing (é˜¶æ¢¯åŒ–)** ä¸ **DPR é”æ­»**ã€‚
* **å®ç°**: `RemoteUrlBuilder` å¼ºåˆ¶é”æ­» `DPR=3.0`ï¼Œå¹¶å°†å®½åº¦å½’ä¸€åŒ–ä¸º `240/480`ã€‚ç¡®ä¿ UI å±‚ä¸ Preloader å±‚ç”Ÿæˆçš„ Cache Key **100% å­—èŠ‚çº§ä¸€è‡´**ã€‚
* **[Time] NTP é«˜ç²¾æ—¶é—´æ ¡å‡† (Chronos Sync)** **[NEW - v5.3.3]**:
* **æ ¸å¿ƒ**: App å¯åŠ¨åŠç½‘ç»œæ¢å¤æ—¶ï¼Œè‡ªåŠ¨ä¸æœåŠ¡ç«¯å¯¹æ—¶ (`ServerTimeHelper`)ã€‚
* **ä»·å€¼**: æ‰€æœ‰é€»è¾‘åŸºäºç»Ÿä¸€çš„æœåŠ¡ç«¯æ—¶é—´è½´ï¼Œå½»åº•è§£å†³æ‰‹æœºç³»ç»Ÿæ—¶é—´ä¸å‡†å¯¼è‡´çš„æ¶ˆæ¯ä¹±åºã€‚

---

## ğŸ¥ˆ ç¬¬äºŒç« ï¼šå…¨å±€ä¸€è‡´æ€§ä¸çŠ¶æ€æ„ŸçŸ¥ (Consistency Era) **[v5.3.0 - v5.3.1]**

*æœ¬ç« æ ‡å¿—ç€ App ä»â€œå•æœºä½“éªŒâ€èµ°å‘â€œç³»ç»Ÿçº§èåˆâ€ï¼Œå½»åº•è§£å†³äº†åˆ†å¸ƒå¼ç³»ç»Ÿæœ€éš¾çš„æ•°æ®å¯¹é½é—®é¢˜ã€‚*

* **[Zero-State] åŒé‡è‡ªæ„ˆé˜²çº¿ (Double Self-Healing)** **[NEW - v5.3.1]**:
* **ç—›ç‚¹**: è§£å†³å¤šç«¯ç™»å½•ã€é‡è£…åº”ç”¨æˆ–åå°é•¿æœŸæŒ‚èµ·åï¼Œæ¶ˆæ¯å†…å®¹å·²åŒæ­¥ä½†åˆ—è¡¨ä»æ˜¾ç¤ºâ€œå¹½çµçº¢ç‚¹â€çš„é¡½ç–¾ã€‚
* **ç¬¬ä¸€é“é˜²çº¿ (Global List Sync)**: åˆ—è¡¨é¡µå¯åŠ¨æ—¶å¼ºåˆ¶æ‰§è¡Œ `ConversationList._fetchList`ï¼Œåˆ©ç”¨ **Server Truth** (æœåŠ¡ç«¯çŠ¶æ€) å¼ºè¡Œè¦†ç›–æœ¬åœ°æ—§æ•°æ®ï¼Œå®ç°â€œæœªè¿›æˆ¿å…ˆæ¶ˆçº¢â€ã€‚
* **ç¬¬äºŒé“é˜²çº¿ (Nuclear Option)**: æˆ¿é—´é¡µ `performIncrementalSync` å¼•å…¥ **æ ¸å¼¹çº§æ¸…é›¶** (`forceClearUnread`)ã€‚å½“æœåŠ¡ç«¯è¿”å› `unread=0` ä½†æœ¬åœ° `unread>0` æ—¶ï¼Œæ— æ¡ä»¶å¼ºåˆ¶æŠ¹å¹³æœ¬åœ°çº¢ç‚¹ï¼Œå¹¶é™é»˜ä¿®æ­£æ¶ˆæ¯çŠ¶æ€ã€‚
* **[Guard] æ™ºèƒ½ API æ‹¦æˆªç³»ç»Ÿ (Smart Gatekeeper)** **[NEW - v5.3.1]**:
* **æ ¸å¿ƒ**: åœ¨ `ChatRoomController` å»ºç«‹é—¨å«æœºåˆ¶ (`checkAndMarkRead`)ã€‚
* **é€»è¾‘**: è¿›æˆ¿æˆ–åˆ‡å›å‰å°æ—¶ï¼Œå…ˆæŸ¥è¯¢æœ¬åœ° `Repo`ã€‚åªæœ‰æœ¬åœ°ç¡®å®æœ‰æœªè¯» (`unread > 0`) æ—¶æ‰å‘èµ· API è¯·æ±‚ã€‚
* **æ¸…é™¤å†…é¬¼**: å½»åº•ç§»é™¤äº† `ChatEventHandler` åˆå§‹åŒ–æ—¶æ— è„‘è°ƒç”¨ `markAsRead` çš„å†—ä½™ä»£ç ï¼Œæœç»äº†è¿›æˆ¿ç¬é—´çš„æ— æ•ˆæµé‡å’Œé‡å¤è¯·æ±‚ã€‚
* **[Unread] å…¨å±€æœªè¯»æ•°èšåˆ (Global Aggregation)** **[v5.3.0]**:
* **æ ¸å¿ƒé€»è¾‘**: å»ºç«‹ `GlobalUnreadProvider`ï¼Œåˆ©ç”¨ Sembast/Isar çš„ `query.onSnapshots` å®æ—¶ç›‘å¬ `conversations` è¡¨ã€‚
* **å®ç°**: `stream.map((list) => list.fold(0, (sum, item) => sum + item.unreadCount))`ï¼Œå®ç°å…¨ App æœªè¯»æ•°æ¯«ç§’çº§å“åº”ï¼Œç›´æ¥é©±åŠ¨åº•éƒ¨å¯¼èˆªæ çº¢ç‚¹ã€‚
* **[Badge] ç³»ç»Ÿçº§è§’æ ‡é—­ç¯ (System Badge Loop)** **[v5.3.0]**:
* **æ ¸å¿ƒé€»è¾‘**: åœ¨æ•°æ®æŒä¹…å±‚ `LocalDatabaseService` æ·±åº¦é›†æˆ `flutter_app_badger`ã€‚
* **å®ç°**: æ‰“é€š FCM åå°å”¤é†’ã€å‰å°æ¶ˆæ¯æ¥æ”¶ã€ç”¨æˆ·æ‰‹åŠ¨å·²è¯»çš„å…¨é“¾è·¯ã€‚åªè¦æœªè¯»æ•°å‘ç”Ÿå˜åŒ–ï¼Œç«‹å³åŒæ­¥è‡³æ‰‹æœºæ¡Œé¢å›¾æ ‡ï¼Œæ”¯æŒ Android (å°ç±³/ä¸‰æ˜Ÿ/åä¸º) åŠ iOSã€‚
* **[Read] å®æ—¶å·²è¯»å›æ‰§ (Real-time Receipts)** **[v5.3.0]**:
* **æ ¸å¿ƒé€»è¾‘**: `ChatEventHandler` å®ç°äº† **500ms é˜²æŠ– (Debounce)** çš„å·²è¯»ä¸ŠæŠ¥æœºåˆ¶ã€‚
* **å®ç°**: é…åˆ `didChangeAppLifecycleState`ï¼Œå½“ç”¨æˆ·è¿›å…¥æˆ¿é—´æˆ–ä»åå°åˆ‡å›å‰å°æ—¶ï¼Œè‡ªåŠ¨è§¦å‘çŠ¶æ€å¯¹é½ï¼Œæå¤§é™ä½ API è°ƒç”¨é¢‘ç‡ã€‚

---

## ğŸ¥‰ ç¬¬ä¸‰ç« ï¼šé«˜å¯é æµæ°´çº¿ä¸æ•°æ®é˜²å¾¡ (Reliability Era) **[Core Architecture]**

*æœ¬ç« æ˜¯ Lucky IM çš„â€œå¿ƒè„â€ï¼Œä¹Ÿæ˜¯ä»£ç ä¸­æœ€ç¡¬æ ¸çš„éƒ¨åˆ†ï¼Œç¡®ä¿æ¶ˆæ¯å¿…è¾¾ã€æ•°æ®ä¸ä¸¢ã€‚*

* **[Arch] ä»“åº“æ¨¡å¼é‡æ„ (Repository Pattern)** **[NEW - v5.3.1]**:
* **åŠ¨ä½œ**: åˆ›å»º `MessageRepository`ï¼Œæ”¶å£æ‰€æœ‰ DB å†™æ“ä½œã€‚
* **ä»·å€¼**: å°† `ChatViewModel` ä¸åº•å±‚ DB è§£è€¦ï¼Œç¡®ä¿æ‰€æœ‰æ•°æ®å†™å…¥éƒ½ç»è¿‡ç»Ÿä¸€çš„é˜²å¾¡é€»è¾‘æ£€æŸ¥ï¼Œé˜²æ­¢ä¸šåŠ¡å±‚ç›´æ¥æ“ä½œ DB å¯¼è‡´çš„æ•°æ®æ±¡æŸ“ã€‚
* **[Defense] æ•°æ®åº“åˆå¹¶é˜²å¾¡ (Data Defense Strategy)** **[Core - v5.3.0]**:
* **æ ¸å¿ƒ**: **æœ¬åœ°é«˜æ¸…èµ„äº§ä¼˜å…ˆåŸåˆ™**ã€‚
* **å®ç°**: `LocalDatabaseService._mergeMessageData`ã€‚
* **ç»†èŠ‚**: å½“æœåŠ¡ç«¯å›åŒ…ï¼ˆSyncï¼‰æ—¶ï¼Œå¦‚æœæœåŠ¡ç«¯ä»…è¿”å› URLï¼ˆé€šå¸¸æ˜¯å‹ç¼©å›¾ï¼‰ï¼Œæœ¬åœ°é€»è¾‘ä¼š**å¼ºåˆ¶ä¿ç•™**å‘é€æ—¶çš„ `localPath` (é«˜æ¸…åŸå›¾) å’Œ `previewBytes` (å†…å­˜å¿«ç…§)ã€‚**è¿™ç¡®ä¿äº†å‘é€è€…æ°¸è¿œçœ‹åˆ°æœ€æ¸…æ™°çš„å›¾ç‰‡ï¼Œ0 å»¶è¿Ÿï¼Œ0 æµé‡æ¶ˆè€—**ã€‚
* **[Engine] äº”çº§è·³å‘é€ç®¡é“ (The 5-Step Pipeline)** **[v5.3.0]**:
* **æ¶æ„**: æ‘’å¼ƒ UI è€¦åˆï¼Œæ„å»º `PipelineRunner`ã€‚
* **æµç¨‹**: **Parse (è§£æ)** -> **Persist (æŒä¹…åŒ–)** -> **Process (å‹ç¼©/æˆªå¸§)** -> **Upload (ä¸Šä¼ )** -> **Sync (SocketåŒæ­¥)**ã€‚
* **ä»·å€¼**: ä»»æ„ç¯èŠ‚å¤±è´¥å‡å¯ç‹¬ç«‹é‡è¯•ï¼Œäº’ä¸é˜»å¡ï¼Œä¸”æ¯ä¸€æ­¥éƒ½è‡ªåŠ¨å›å†™ DB çŠ¶æ€ã€‚
* **[Sync] å¢é‡åŒæ­¥è‡ªæ„ˆ (Incremental Self-Healing)** **[v5.3.0]**:
* **ç®—æ³•**: `ChatViewModel` å®ç°åŸºäº `localMaxSeqId` çš„ç©ºæ´æ£€æµ‹ã€‚
* **è‡ªæ„ˆ**: å‘ç°æœ¬åœ° SeqId ä¸è¿ç»­æ—¶ï¼Œè‡ªåŠ¨é€’å½’æ‹‰å–ä¸­é—´ç¼ºå¤±çš„æ¶ˆæ¯ (`_recursiveSyncGap`)ï¼Œç¡®ä¿æ¶ˆæ¯æµç»å¯¹å®Œæ•´ã€‚
* **[Retry] ç¦»çº¿è‡ªåŠ¨é‡å‘ (Offline Auto-Retry)** **[v5.3.0]**:
* **å®ç°**: `OfflineQueueManager` ç›‘å¬ `Connectivity`ã€‚ç½‘ç»œæ¢å¤ç¬é—´ï¼Œè‡ªåŠ¨å†²åˆ·å¤±è´¥é˜Ÿåˆ—ã€‚

---

## ğŸ… ç¬¬å››ç« ï¼šå…¨èƒ½åª’ä½“ä¸é›¶æ„Ÿäº¤äº’ (Media Era) **[v5.3.1]**

*æœ¬ç« æ”»å…‹äº† IM æœ€å¤æ‚çš„åª’ä½“å¤„ç†ä¸è·¨å¹³å°å…¼å®¹æ€§ï¼Œå®ç°äº†â€œå¦‚ä¸èˆ¬é¡ºæ»‘â€çš„ä½“éªŒã€‚*

* **[Streaming] å…¨é“¾è·¯æµå¼ç¼“å†² (Streaming Buffer)** **[NEW - v5.3.1]**:
* **å®¢æˆ·ç«¯**: `VideoPlaybackService` æ˜¾å¼æ·»åŠ  `httpHeaders: {'Range': 'bytes=0-'}`ï¼Œæ¿€æ´»æ’­æ”¾å™¨çš„åˆ†ç‰‡ä¸‹è½½èƒ½åŠ›ã€‚
* **æœåŠ¡ç«¯**: Nginx é…ç½® `proxy_force_ranges on` åŠ `proxy_buffering off`ï¼Œå¹¶é€ä¼  CORS/SNI å¤´ï¼Œå®Œç¾æ”¯æŒ Cloudflare/S3 çš„æµå¼å›æºã€‚
* **æ•ˆæœ**: 500MB å¤§è§†é¢‘ç‚¹å‡»å³æ’­ (Instant Play)ï¼Œæ”¯æŒä»»æ„æ‹–æ‹½è¿›åº¦æ¡ï¼Œæ— éœ€ç­‰å¾…å…¨é‡ä¸‹è½½ã€‚
* **[Cache] ä¸‰çº§æ’­æ”¾ç­–ç•¥ (Triple-Level Caching)** **[NEW - v5.3.1]**:
* **é€»è¾‘**: `getPlayableSource` ä¾æ¬¡æ£€æŸ¥ **å†…å­˜å¿«ç…§ -> æœ¬åœ° Asset æ–‡ä»¶ -> ç½‘ç»œ URL**ã€‚
* **ä»·å€¼**: æœ¬æœºå‘é€çš„è§†é¢‘ç›´æ¥è¯»æ–‡ä»¶ï¼Œå®ç° **0 å»¶è¿Ÿ** æ’­æ”¾ã€‚
* **[Path] è·¨å¹³å°è·¯å¾„å½’ä¸€åŒ– (Path Normalization)** **[v5.3.0]**:
* **ç—›ç‚¹**: iOS App æ›´æ–°åæ²™ç›’ UUID å˜æ›´ï¼Œå¯¼è‡´æ•°æ®åº“é‡Œçš„ç»å¯¹è·¯å¾„å¤±æ•ˆã€‚
* **æ–¹æ¡ˆ**: æ•°æ®åº“åªå­˜â€œä¸šåŠ¡ç›¸å¯¹è·¯å¾„â€ï¼ˆå¦‚ `chat_images/xxx.jpg`ï¼‰ã€‚
* **å®ç°**: `AssetManager.getRuntimePath()` åœ¨è¿è¡Œæ—¶åŠ¨æ€å°†ç›¸å¯¹è·¯å¾„æ‹¼æ¥ä¸ºå½“å‰æ²™ç›’çš„ç»å¯¹è·¯å¾„ã€‚`VideoMsgBubble` å’Œ `VoiceBubble` å·²å…¨é¢æ¥å…¥ã€‚
* **[UX] é›¶å»¶æ—¶å¤§å›¾é¢„è§ˆ (Zero-Latency Preview)** **[v5.3.0]**:
* **æ ¸å¿ƒ**: **Cache Key æŒ‡çº¹å¯¹é½**ã€‚
* **å®ç°**: `PhotoPreviewPage` å¼ºåˆ¶å¤ç”¨åˆ—è¡¨é¡µ `AppCachedImage` çš„ URL å’Œ Headersã€‚é…åˆ `metadata` (å®½é«˜) é¢„æ’‘å¼€å®¹å™¨ï¼Œå®ç°ç‚¹å¼€å¤§å›¾ **0ms åŠ è½½**ï¼Œæ— ä»»ä½•è§†è§‰æŠ–åŠ¨æˆ–é»‘å±ã€‚
* **[Web] ç‰©ç†çº§ç¯å¢ƒéš”ç¦» (Environment Isolation)** **[v5.3.0]**:
* **è§†é¢‘**: Web ç«¯ä½¿ç”¨ HTML5 `Canvas` æˆªå–é¦–å¸§ (`web_video_thumbnail_service.dart`)ï¼ŒNative ç«¯ä½¿ç”¨ FFmpegã€‚
* **æ–‡ä»¶**: Web ç«¯ä½¿ç”¨ `Blob URL` (`save_poster_web.dart`)ï¼ŒNative ç«¯ä½¿ç”¨ `File` å’Œç›¸å†Œ APIã€‚
* **å½•éŸ³**: Web ç«¯å±è”½æµè§ˆå™¨å³é”®èœå• (`voice_record_button_web_utils`)ï¼Œå®ç°äº†çº¯å‡€çš„å½•éŸ³ä½“éªŒã€‚
* **æ¸…ç†**: å®ç°äº† `_clearDeadBlobs`ï¼Œåœ¨ Web ç«¯å¯åŠ¨æ—¶è‡ªåŠ¨æ¸…ç†å¤±æ•ˆçš„ Blob é“¾æ¥ã€‚

---

## ğŸ’ ç¬¬äº”ç« ï¼šåç«¯è§£è€¦ä¸è§¦è¾¾ (Backend Era) **[v5.2.1]**

* **[Arch] äº‹ä»¶é©±åŠ¨æ¶æ„**: å¼•å…¥ `@nestjs/event-emitter`ï¼Œå°† `ChatService` çº¯ç²¹åŒ–ï¼Œå½»åº•ç§»é™¤å¯¹ Socket å’Œ FCM æœåŠ¡çš„ç›´æ¥ä¾èµ–ã€‚
* **[DTO] çŠ¶æ€å¯¹é½åè®®** **[NEW - v5.3.1]**: å‡çº§ DTOï¼Œåœ¨ä¼šè¯è¯¦æƒ…æ¥å£å¢åŠ  `unreadCount`, `myLastReadSeqId` ç­‰å…³é”®å­—æ®µï¼Œä¸ºå‰ç«¯è‡ªæ„ˆæä¾›å¼¹è¯ã€‚
* **[FCM] å…¨å¹³å°ç¦»çº¿è§¦è¾¾**: æ‰“é€š Android (High Importance Channel) ä¸ Web (Service Worker) æ¨é€ï¼Œå®æ–½æ•°æ®å†—ä½™ç­–ç•¥ï¼ˆData Redundancyï¼‰é˜²æ­¢é€šçŸ¥å†…å®¹ä¸¢å¤±ã€‚

---

## ğŸ›¡ï¸ ç¬¬å…­ç« ï¼šç¤¾äº¤åŸºå»ºä¸æ€§èƒ½ä¼˜åŒ– (Foundation Era) **[v4.0 - v5.0]**

* **[Social] æ‹¼éŸ³æœç´¢å¼•æ“**: `ContactRepository` é›†æˆ `lpinyin`ï¼Œæ„å»ºæœ¬åœ°å€’æ’ç´¢å¼•ï¼Œæ”¯æŒæ¯«ç§’çº§é€šè®¯å½•æœç´¢ã€‚
* **[Perf] æ¥å£é£æš´æ­¢è¡€**: ç§»é™¤ `ConversationItem` å¯¹ `chatDetailProvider` çš„é”™è¯¯ç›‘å¬ï¼Œåˆ—è¡¨é¡µè¯·æ±‚æ•°ä» N+1 é™ä¸º 1ã€‚
* **[UI] ç°ä»£åŒ–è¾“å…¥æ¡†**: `ModernChatInputBar` å®ç°é”®ç›˜/è¡¨æƒ…é¢æ¿æ— ç¼åˆ‡æ¢ï¼Œé›†æˆ `ChatActionSheet` é…ç½®åŒ–èœå•ã€‚
* **[LBS] åœ°å›¾æœåŠ¡**: Web ç«¯ä¼˜åŒ– `LocationMsgBubble`ï¼Œä½¿ç”¨ `AutomaticKeepAliveClientMixin` ç¼“å­˜åœ°å›¾å¿«ç…§ï¼Œè§£å†³æ»šåŠ¨é—ªçƒé—®é¢˜ã€‚

---

## ğŸ›¡ï¸ æ¶æ„é“å¾‹ (The Iron Rules - v6.0.0)

*è¿™æ˜¯é¡¹ç›®çš„æœ€é«˜å‡†åˆ™ï¼Œä»»ä½•ä»£ç æäº¤ä¸å¾—è¿åã€‚*

1. **æƒé™æƒå¨åŸåˆ™ [NEW]**: æ‰€æœ‰æ¶‰åŠç¾¤ç»„å˜æ›´çš„æ“ä½œå¿…é¡»ç»è¿‡ `_checkPermission` (åç«¯) ä¸ `canManage` (å‰ç«¯) æ ¡éªŒï¼ŒUI å±‚å¿…é¡»å®æ—¶å“åº”æƒé™çŠ¶æ€ã€‚
2. **å¼‚æ­¥æ‹¦æˆªåŸåˆ™ [NEW]**: æ‰€æœ‰çš„é€»è¾‘å¤„ç†å™¨ï¼ˆHandlerï¼‰ä¸æ§åˆ¶å™¨ï¼ˆControllerï¼‰å¿…é¡»åŒ…å« `_isDisposed` çŠ¶æ€æ£€æŸ¥ï¼Œä¸¥ç¦åœ¨é¡µé¢é”€æ¯åæ‰§è¡Œä»»ä½•å¼‚æ­¥å›è°ƒã€‚
3. **ç³»ç»Ÿæ¶ˆæ¯å…æŠ¥åŸåˆ™ [NEW]**: ç±»å‹ä¸º `99` çš„ç³»ç»Ÿé€šçŸ¥ä¸¥ç¦è§¦å‘å·²è¯»ä¸ŠæŠ¥ï¼ˆ`markAsRead`ï¼‰é€»è¾‘ï¼Œè§„é¿å› æƒé™ç¬é—´ä¸¢å¤±å¼•å‘çš„ 403 ç«æ€å†²çªã€‚
4. **å®‰å…¨è·³è½¬åŸåˆ™ [NEW]**: ä»»ä½•ç”± Socket ä¿¡ä»¤è§¦å‘çš„è‡ªåŠ¨è·³è½¬å¿…é¡»åŒ…è£¹åœ¨ `addPostFrameCallback` ä¸­ï¼Œå¹¶æ˜¾å¼æ”¶èµ·é”®ç›˜ï¼Œé˜²æ­¢æ¸²æŸ“æ–­è¨€å´©æºƒã€‚
5. **è·¯å¾„ç›¸å¯¹åŒ–åŸåˆ™**: æ•°æ®åº“æŒä¹…åŒ–**ä¸¥ç¦å­˜å‚¨ç»å¯¹è·¯å¾„**ï¼Œå¿…é¡»é€šè¿‡ `AssetManager` åœ¨è¿è¡Œæ—¶åŠ¨æ€è¿˜åŸã€‚
6. **æ•°æ®é˜²å¾¡åŸåˆ™**: `merge` æ“ä½œå¿…é¡»**ä¼˜å…ˆä¿ç•™æœ¬åœ°**çš„ `localPath` (é«˜æ¸…) å’Œ `previewBytes` (å†…å­˜å¿«ç…§)ï¼Œä¸¥ç¦è¢«æœåŠ¡ç«¯ç©ºå€¼è¦†ç›–ã€‚
7. **å•å‘æ•°æ®æµ**: UI **åªè¯» DB**ï¼ŒPipeline/Repo **è´Ÿè´£å†™ DB**ã€‚ç¦æ­¢ UI ç›´æ¥æ¸²æŸ“ API è¿”å›çš„æ•°æ®ã€‚
8. **æœåŠ¡ç«¯æƒå¨åŸåˆ™**: å½“æœåŠ¡ç«¯è¿”å› `unread=0` æ—¶ï¼Œæœ¬åœ°å¿…é¡»æ— æ¡ä»¶å¼ºåˆ¶æ¸…é›¶ (`forceClearUnread`)ã€‚
9. **æŒ‡çº¹å¯¹é½åŸåˆ™**: è·¨é¡µé¢å¤ç”¨åª’ä½“ç¼“å­˜ï¼Œ`ImageProvider` çš„ URL å’Œ Headers å¿…é¡»å­—ç¬¦çº§åŒ¹é…ï¼ˆé”æ­» DPR=3.0ï¼‰ã€‚
10. **è§†è§‰å…œåº•åŸåˆ™**: å›¾ç‰‡åŠ è½½å¿…é¡»ä½¿ç”¨ `Stack`ï¼Œåº•å±‚å¿…é¡»å«ç€ `previewBytes`ï¼Œä¸¥ç¦è®©ç”¨æˆ·çœ‹åˆ°ç™½å±æˆ– Loadingã€‚
11. **æ—¶é—´ç»Ÿä¸€åŸåˆ™**: æ‰€æœ‰çš„é€»è¾‘åˆ¤æ–­ï¼ˆæ’åºã€è¶…æ—¶ï¼‰å¿…é¡»ä½¿ç”¨ `ServerTimeHelper.now()`ã€‚
12. **èµ„æºåˆ†çº§åŸåˆ™**: è§†é¢‘æ’­æ”¾å¿…é¡»éµå¾ª **Local -> Cache -> Streaming** çš„é™çº§ç­–ç•¥ã€‚
13. **Web ç¯å¢ƒéš”ç¦»**: é `kIsWeb` ä¿æŠ¤ä¸‹ï¼Œ**ä¸¥ç¦è°ƒç”¨ `dart:io**`ã€‚

---