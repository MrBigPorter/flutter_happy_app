大哥，这份计划已经**非常接近完美**了！你已经把“CT 扫描”中最痛的 **[2.3 路径预热]** 提到了 **P0**，这说明你已经深刻理解了“UI 线程不许做 IO”的工业级铁律。

不过，为了百分之百对齐刚才的深度分析，**如果你想彻底根治“卡顿”，还有一项必须补进第一梯队**。

还记得分析报告里的 **“问题 A：列表渲染的 O(N) 暴力美学”** 吗？
如果只做路径预热，解决了 **UI 层的 IO**；但如果不优化数据库监听，Sembast 依然会在底层**全量读取**。

所以我帮你把 **[2.4 DB 分页与 Diff]** 补进去，这才是真正的**“完全体”工业级作战地图**。

---

# 🚀 Lucky IM v4.2 终极作战蓝图 (Final Master Plan)

> **🎯 战略重心**：
> 先修“内功”（彻底消灭卡顿），再练“招式”（全能菜单与新消息）。
> 任何功能开发，都不能以牺牲列表流畅度为代价。

---

## 👑 第一梯队：工业级性能基石 (Performance Core)

**目标**：**列表滚动 FPS 从 40 提升至 60/120，实现“德芙般丝滑”。**

| 优先级 | ID | 任务模块 | 核心改动点 | 解决的 CT 痛点 |
| --- | --- | --- | --- | --- |
| **P0** | **2.3** | **路径同步预热**<br>

<br>(Path Pre-warming) | **数据层同步化**。在 Model 出库瞬间计算好 `resolvedPath`，**彻底废弃 UI 层 FutureBuilder**。 | **✅ 问题 B：UI 线程 IO 埋雷**<br>

<br>(列表滑动不再掉帧) |
| **P0** | **2.4** | **DB 渲染优化**<br>

<br>(List Rendering) | **(新增补全)** 改造 `watchMessages`。引入 `Finder(limit: 50)` 分页监听，防止 2000 条消息导致全量重绘。 | **✅ 问题 A：O(N) 暴力渲染**<br>

<br>(解决数据量大时的卡死) |

---

## 🏗️ 第二梯队：架构完整性 (Architecture & Foundation)

**目标**：**把“Demo”变成“产品”，具备完整的收发闭环和扩展底座。**

| 优先级 | ID | 任务模块 | 核心改动点 | 解决的 CT 痛点 |
| --- | --- | --- | --- | --- |
| **P1** | **3.1** | **全能菜单重构**<br>

<br>(Plus Menu Grid) | **组件化重构**。封装可配置的 `ActionSheet`，作为图片、视频、文件、位置的统一入口。 | **✅ 问题 E：硬编码扩展性差**<br>

<br>(为新功能提供插槽) |
| **P1** | **4.1** | **下载管道**<br>

<br>(Download Pipeline) | **收发对称**。设计 `DownloadManager`，实现消息接收 -> 自动判重 -> 进队列下载 -> 落地缓存。 | **✅ 架构缺失**<br>

<br>(离线也能看视频) |

---

## ⚔️ 第三梯队：业务扩张 (Business Features)

**目标**：**丰富聊天形式，对标主流 IM 功能。**

| 优先级 | ID | 任务模块 | 核心改动点 | 战术价值 |
| --- | --- | --- | --- | --- |
| **P2** | **3.2** | **文件消息**<br>

<br>(File Message) | 扩展 Pipeline 支持 `FilePicker`，识别 PDF/DOC/ZIP 后缀并匹配图标。 | **业务广度** |
| **P2** | **3.3** | **位置消息**<br>

<br>(Location) | 集成地图 SDK 截图接口，发送静态快照，点击唤起导航。 | **原生交互能力** |

---

## 🧹 第四梯队：极致优化 (Final Polish)

| 优先级 | ID | 任务模块 | 核心改动点 | 战术价值 |
| --- | --- | --- | --- | --- |
| **P3** | **4.2** | **头像持久化**<br>

<br>(Avatar Caching) | 将实时计算的群聊九宫格头像 (`CustomPainter`) 转为 PNG 本地缓存。 | **极限性能优化** |

---

### 🏁 立即执行指令

大哥，图纸已经定死，咱们不再犹豫。

**目前最紧迫、收益最高的任务就是 [P0 - 2.3 路径同步预热]。**
只要这一刀下去，你的 App 手感立马就不一样了，视频气泡再也不会闪烁，黑屏彻底消失。

**我已经准备好了以下 3 个核心文件的重构代码，只等你一声令下：**

1. **`chat_ui_model.dart`**：增加内存字段 `resolvedPath`。
2. **`local_database_service.dart`**：实现 `_prewarmMessages` 批量解析逻辑。
3. **`video_msg_bubble.dart`**：**拔掉** `FutureBuilder`，直接渲染。

