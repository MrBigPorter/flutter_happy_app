既然**文件全链路 (P0 - 3.2)** 和 **重发管道 (P1 - 4.1)** 已经彻底拿下，咱们的进度条又往前狠狠推了一大截。

这是剔除已完成项、并根据当前最新代码状态（已解决 `ProviderContainer` 报错与 `isSelf` 逻辑）重定义的 **v4.9 攻坚版计划**。现在的重心正式转向**“用户体验的精致化”**与**“功能边界的扩张”**。

---

# 🚀 Lucky IM Project Master Plan v4.9 (Refinement & Expansion)

> **🔴 状态校准 (2026-02-01 下午)**
> **刚刚完成 (Moved to Done)**：
> * ✅ **文件消息 (P0)**：`file_picker` 集成、`FileMsgBubble` 开发、Web 端 PDF 乱码修复。
> * ✅ **重发机制 (P1)**：`OfflineQueueManager` 修复、`ProviderContainer` 作用域对齐。
> * ✅ **撤回同步 (P1)**：后端推送补全、`isSelf` 逻辑闭环。
>
>

---

## 👑 第一梯队：交互与性能优化 (Refinement)

**目标：让 App 从“能用”变成“好用”，消除滑动与加载的各种“肉感”。**

| 优先级 | ID | 任务模块 | 核心技术方案 | 解决痛点 |
| --- | --- | --- | --- | --- |
| **🔥 P0** | **4.2** | **头像持久化与预加载** | **二级缓存策略**：<br>

<br>1. 改造 `GroupAvatar`，将 Canvas 绘制结果通过 `toImage()` 转为字节流存入 `AssetManager`。<br>

<br>2. 列表滑动时直接读本地 File，不再实时重绘九宫格。 | 现状：群聊列表多的时候，滑动会有轻微掉帧。 |
| **P1** | **4.3** | **消息发送状态动画** | **UI 微调**：<br>

<br>1. 优化消息上屏后的“发送中” Loading 样式。<br>

<br>2. 增加发送成功后的“渐隐”效果或“已读”文字的平滑出现。 | 现状：状态切换比较生硬，缺乏呼吸感。 |

---

## ⚔️ 第二梯队：新业务板块 (New Frontiers)

**目标：增加 IM 的功能厚度，支持更多社交维度。**

| 优先级 | ID | 任务模块 | 说明 | 复杂度 |
| --- | --- | --- | --- | --- |
| **🔥 P1** | **3.3** | **位置消息 (Location)** | **核心逻辑**：<br>

<br>1. **发送**：调用定位权限，获取经纬度，并截取一张静态图作为 `meta['thumb']`。<br>

<br>2. **接收**：显示地图卡片，点击调用 `url_launcher` 唤起手机自带的地图 App（高德/Google/Apple Maps）。 | ⭐⭐⭐⭐ |
| **P2** | **5.1** | **联系人管理 (Contacts)** | **社交基础**：<br>

<br>1. 实现“搜索手机号加好友”。<br>

<br>2. 好友申请列表（待处理/已通过）。<br>

<br>3. 通讯录列表（按字母 A-Z 排序）。 | ⭐⭐⭐ |
| **P3** | **5.2** | **朋友圈/动态 (Moments)** | **扩展模块**：<br>

<br>基于现有的 `GlobalUploadService` 扩展图文发布功能。 | ⭐⭐⭐⭐⭐ |

---

### 💡 下一步行动 (Immediate Action)

**建议先搞 P0 - 4.2 头像持久化。**

虽然 **位置消息 (3.3)** 很诱人，但头像持久化是解决“列表丝滑度”的关键，这关乎 App 的第一印象。

**具体步骤：**

1. 检查 `GroupAvatar` 组件，看它现在是怎么拼图的。
2. 引入一个简单的本地缓存 Key 逻辑：`avatar_cache_{conversationId}_{members_hash}.png`。
3. 如果本地有，直接显示 `FileImage`；没有，再跑绘制逻辑并保存。

**大哥，是先去优化列表流畅度（头像缓存），还是直接开搞“位置分享”？**