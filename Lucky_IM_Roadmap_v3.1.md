大哥，这份 **v4.6 计划** 已经根据今晚的战果（图片渲染优化、Web上传修复、SeqId统一）进行了深度迭代。

现在的重点非常清晰：**前端渲染瓶颈已破，下一步要解决“网络协议瓶颈”和“长列表数据瓶颈”。**

---

# 🚀 Lucky IM Project Master Plan v4.6 (Protocol & Performance)

> **🔴 状态校准 (2026-01-30)**
> **已完成 (Moved to Done)**：
> * ✅ **核心架构**：SeqId 分页游标统一 (前后端握手成功)
> * ✅ **Web 兼容**：图片/视频上传 Pipeline 重构 (解决 Blob/MimeType 丢失导致的 404/CORS)
> * ✅ **渲染性能**：图片列表秒开优化 (去动画、MemCacheWidth 内存限制、强制 Web 磁盘缓存)
>
>
> **当前战役重心**：
> 这一秒我们解决了“渲染卡”，下一秒我们要解决“网络堵”和“滑动卡”。
> **新增 P1 级任务：HTTP/2 协议升级 & BlurHash 视觉占位。**

---

## 👑 第一梯队：数据流与列表性能 (The P0 Core)

**目标**：**让列表在 10 万条数据下依然能跑满 120fps，彻底消除“滑动顿挫”。**

| 优先级 | ID | 任务模块 | 核心技术方案 | 解决痛点 |
| --- | --- | --- | --- | --- |
| **P0** | **2.3** | **智能分页 (DB层)**<br>

<br>(Smart Pagination) | **基于 SeqId 的本地分页**：<br>

<br>1. **改造 `watchMessages**`：不再一次性吐出所有数据，改为 `Sembast` 的 `Finder` 配合 `limit: 50` + `offset`。<br>

<br>2. **双向游标**：同时维护 `minSeqId` (上拉加载) 和 `maxSeqId` (新消息插入)。 | **✅ 解决：**<br>

<br>大群聊天记录过多时，一次性加载导致内存暴涨、UI 线程阻塞卡死。 |
| **P0** | **2.4** | **无感预取与预热**<br>

<br>(Pre-fetch & Pre-warm) | **UI 与 IO 的完美配合**：<br>

<br>1. **Scroll 监听**：在列表滚动到距顶部 **500px** 时，静默触发 `loadPrevious()`，用户无感知。<br>

<br>2. **Asset 解析预热**：在数据送入 UI 前，通过 `PrewarmService` 提前解析好 `AssetId -> 绝对路径`，填入 `readyPath` 字段。 | **✅ 解决：**<br>

<br>快速滑动时的“白屏”等待；<br>

<br>消除滚动时的掉帧感。 |

---

## ⚡️ 第二梯队：网络协议与视觉体验 (Network & UX) —— **[NEW]**

**目标**：**突破 HTTP/1.1 并发限制，实现“零延迟”视觉感知。**

| 优先级 | ID | 任务模块 | 核心技术方案 | 说明 |
| --- | --- | --- | --- | --- |
| **P1** | **5.1** | **HTTP/2 协议升级**<br>

<br>(Protocol Upgrade) | **基础设施升级 (Ops)**：<br>

<br>1. **Cloudflare/Nginx**：开启 `HTTP/2` 和 `HTTP/3 (QUIC)`。<br>

<br>2. **验证**：确保 Network 面板协议显示 `h2`，彻底消除 6 个并发限制导致的排队阻塞。 | **新增原因**：<br>

<br>日志分析显示首次加载存在 1-3秒 的排队延迟 (Waterfall)。 |
| **P1** | **5.2** | **BlurHash 视觉占位**<br>

<br>(Visual Perception) | **后端+前端联动**：<br>

<br>1. **后端**：上传图片时计算 `BlurHash` 字符串存入 DB。<br>

<br>2. **前端**：`AppCachedImage` 增加 `placeholder` 逻辑，在网络请求期间直接绘制模糊缩略图。 | **新增原因**：<br>

<br>消除网络握手期间的“灰块/白屏”，提升感知速度。 |

---

## 🏗️ 第三梯队：功能架构补全 (Infrastructure)

**目标**：**构建可扩展的 IM 业务底座。**

| 优先级 | ID | 任务模块 | 核心技术方案 |
| --- | --- | --- | --- |
| **P1** | **3.1** | **全能菜单架构**<br>

<br>(Plus Menu Grid) | **组件化重构**。<br>

<br>废弃硬编码菜单，封装 `ChatActionSheet`。将图片、视频、拍摄拆分为独立 Plugin，为后续文件/位置消息预留插槽。 |
| **P2** | **4.1** | **自动下载管道**<br>

<br>(Download Pipeline) | **收发对称设计**。<br>

<br>建立 `DownloadManager`，接收到媒体消息时，根据网络状态（WiFi/4G）自动加入下载队列。实现“点开即看”，无需等待 Loading。 |

---

## ⚔️ 第四梯队：业务扩张 (Business Features)

**目标**：**对标主流 IM 核心功能。**

| 优先级 | ID | 任务模块 | 说明 |
| --- | --- | --- | --- |
| **P2** | **3.2** | **文件消息** | 扩展 Pipeline 支持 `FilePicker`，识别 PDF/DOC/ZIP/APK 后缀并匹配对应图标，支持进度条显示。 |
| **P3** | **3.3** | **位置消息** | 集成地图 SDK 截图接口，发送静态快照与经纬度，点击唤起第三方导航。 |
| **P3** | **4.2** | **头像持久化** | 将实时计算的群聊九宫格头像 (`CustomPainter`) 转为 PNG 本地缓存，减少 GPU 绘图压力。 |