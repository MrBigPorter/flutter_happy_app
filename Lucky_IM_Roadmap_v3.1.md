大哥，收到！根据刚才的代码审查，**“智能分页”、“无感预热”、“HTTP/2” 和 “BlurHash” 这四座大山已经全部被推平了**。

现存的 v4.6 计划中，**第一梯队 (P0)** 和 **第二梯队 (P1)** 任务已全部完成。

这是为您更新后的 **v4.7 纯净版计划**。现在的战场已经转移到了 **“功能架构”** 和 **“业务扩张”** 上。

---

# 🚀 Lucky IM Project Master Plan v4.7 (Features & Architecture)

> **🔴 状态校准 (2026-01-31)**
> **刚刚完成 (Moved to Done)**：
> * ✅ **性能核心**：智能分页 (Smart Pagination) - DB层/VM层已实装
> * ✅ **体验核心**：无感预热 (Pre-warm) - 路径解析/HTTPS转换已闭环
> * ✅ **视觉核心**：BlurHash 占位 - 告别白屏加载
> * ✅ **网络基建**：HTTP/2 协议 - Nginx 配置已开启
>
>
> **当前战役重心**：
> 基础设施（渲染、网络、数据）已铺设完毕。**现在开始搭建“业务中台”，让 IM 功能丰富起来。**

---

## 🏗️ 第一梯队：架构重构与自动化 (Infrastructure)

**目标**：**把“聊天”变成“全能通讯”，并实现媒体流的自动化管理。**

| 优先级 | ID | 任务模块 | 核心技术方案 | 解决痛点 |
| --- | --- | --- | --- | --- |
| **P0** | **3.1** | **全能菜单架构**<br>

<br>(Plus Menu Grid) | **组件化重构 (Plugin System)**：<br>

<br>1. 废弃当前硬编码的 `_buildMenu`。<br>

<br>2. 封装 `ChatActionSheet` 组件，支持动态注册 `ActionItem`。<br>

<br>3. 将图片、视频、拍摄拆分为独立 Plugin，为后续文件/位置消息预留插槽。 | **现状痛点**：<br>

<br>现在的菜单是写死的，扩展新功能（如发文件）需要改动大量核心 UI 代码，耦合度太高。 |
| **P1** | **4.1** | **自动下载管道**<br>

<br>(Download Pipeline) | **收发对称设计**：<br>

<br>1. 建立 `DownloadManager` (类似 `UploadService`)。<br>

<br>2. 接收到媒体消息时，检测网络状态（WiFi/4G）。<br>

<br>3. **WiFi 下自动下载原图/视频**，写入本地缓存。 | **现状痛点**：<br>

<br>每次点开大图或视频都要转圈加载，体验不够“原生”。实现“点开即看”。 |

---

## ⚔️ 第二梯队：业务扩张 (Business Features)

**目标**：**对标主流 IM (微信/TG) 的核心业务功能。**

| 优先级 | ID | 任务模块 | 说明 | 复杂度 |
| --- | --- | --- | --- | --- |
| **P2** | **3.2** | **文件消息支持**<br>

<br>(File Message) | 扩展 `Pipeline` 支持 `FilePicker`。<br>

<br>需实现：<br>

<br>1. 识别 PDF/DOC/ZIP/APK 后缀并匹配对应图标。<br>

<br>2. 聊天气泡显示文件名、大小。<br>

<br>3. 实现下载进度条气泡。 | ⭐⭐⭐ |
| **P2** | **4.2** | **头像持久化**<br>

<br>(Avatar Caching) | **性能优化**：<br>

<br>目前群聊九宫格头像 (`GroupAvatar`) 是实时计算的。计划将其绘制结果转为 PNG 存入本地 Cache，减少列表滑动时的 GPU 绘图压力。 | ⭐⭐ |
| **P3** | **3.3** | **位置消息**<br>

<br>(Location) | 集成地图 SDK (Google Maps / 高德)。<br>

<br>需实现：<br>

<br>1. 发送：获取经纬度并生成静态地图快照。<br>

<br>2. 接收：显示地图卡片，点击唤起第三方导航 App。 | ⭐⭐⭐⭐ |

---

### 💡 下一步建议 (Next Action)

既然数据层和网络层都通了，建议直接切入 **P0 - 3.1 全能菜单架构**。

* **原因**：你马上要写“文件消息”和“位置消息”，如果现在不把菜单重构好，后面加这两个功能会把 `ChatPage` 的代码撑爆。
* **动作**：创建一个 `chat_action_menu.dart`，把输入框右边的 `+` 号点击逻辑抽离出来，做成可配置的 Grid。