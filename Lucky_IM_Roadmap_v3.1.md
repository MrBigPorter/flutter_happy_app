大哥，收到！**“全能菜单架构” (P0 - 3.1)** 刚才已经随着那波 UI 重构（Push 效果 + 组件化）彻底拿下了。

现在你的 IM 交互框架已经和微信一模一样了。

这是剔除已完成项后的 **v4.8 冲锋版计划**。现在的火力全部集中在 **“填补功能空缺”** 上。

---

# 🚀 Lucky IM Project Master Plan v4.8 (Content & Expansion)

> **🔴 状态校准 (2026-01-31 晚)**
> **刚刚完成 (Moved to Done)**：
> * ✅ **交互架构**：全能菜单 (Plus Menu) - 组件化重构，支持动态配置
> * ✅ **原生体验**：键盘/面板无缝切换 (Push Layout) - 解决输入框被遮挡与底部黑条问题
>
>
> **当前战役重心**：
> 菜单架子搭好了，现在要把里面的 **“文件 (File)”** 按钮做活。
> **最高优先级**：**文件消息的全链路实现 (P0)**。

---

## 👑 第一梯队：核心业务功能 (Core Features)

**目标**：**让 IM 支持发送任意格式的文件，而不只是媒体。**

| 优先级 | ID | 任务模块 | 核心技术方案 | 解决痛点 |
| --- | --- | --- | --- | --- |
| **🔥 P0** | **3.2** | **文件消息支持**<br>

<br>(File Message) | **全链路打通**：<br>

<br>1. **Pipeline 升级**：改造 `ChatActionService`，集成 `file_picker`，支持非媒体文件的上传管道。<br>

<br>2. **Model 升级**：`ChatUiModel` 增加 `fileSize`, `fileName`, `fileExt` 字段。<br>

<br>3. **UI 实现**：开发 `FileBubble`，显示文件图标、大小，点击触发下载/打开。 | **现状**：<br>

<br>菜单里的 "File" 按钮现在是空的，无法发送 PDF/DOC/ZIP 等办公文件。 |
| **P1** | **4.1** | **自动下载管道**<br>

<br>(Download Pipeline) | **收发对称设计**：<br>

<br>1. 建立 `DownloadManager`。<br>

<br>2. 接收到媒体消息时，检测网络状态（WiFi/4G）。<br>

<br>3. **WiFi 下自动下载原图/视频**，写入本地缓存。 | **现状**：<br>

<br>每次点开大图或视频都要转圈加载，体验不够“原生”。目标是“点开即看”。 |

---

## ⚔️ 第二梯队：高级功能与优化 (Advanced & Optimization)

**目标**：**提升 App 的精致度与功能广度。**

| 优先级 | ID | 任务模块 | 说明 | 复杂度 |
| --- | --- | --- | --- | --- |
| **P2** | **4.2** | **头像持久化**<br>

<br>(Avatar Caching) | **性能优化**：<br>

<br>目前群聊九宫格头像 (`GroupAvatar`) 是实时计算的。计划将其绘制结果转为 PNG 存入本地 Cache，减少列表滑动时的 GPU 绘图压力。 | ⭐⭐ |
| **P3** | **3.3** | **位置消息**<br>

<br>(Location) | 集成地图 SDK (Google Maps / 高德)。<br>

<br>需实现：<br>

<br>1. 发送：获取经纬度并生成静态地图快照。<br>

<br>2. 接收：显示地图卡片，点击唤起第三方导航 App。 | ⭐⭐⭐⭐ |

---

### 💡 下一步行动 (Immediate Action)

**直接进攻 P0 - 3.2 文件消息支持。**

我们需要分三步走：

1. **数据层**：修改 `ChatUiModel` 和数据库，确保存储文件名和大小。
2. **逻辑层**：在 `ChatActionService` 里加一个 `sendFile()` 方法。
3. **UI 层**：写一个漂亮的 `FileMsgBubble`。

**大哥，准备好开始写 `sendFile()` 了吗？**