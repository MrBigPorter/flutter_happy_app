收到，大哥！执行计划已更新。去掉了已经完成的管道架构部分，合并了**视频深度优化**与**新功能扩张**，形成这份 **Lucky IM v4.0 核心执行全图**。

这份计划遵循“架构先行，体验跟上”的原则。

---

# 🚦 Lucky IM v4.0 核心执行全图 (Roadmap)

> **当前状态**：声明式消息管道 (Pipeline) 已焊死，逻辑链路已闭环。
> **下一阶段**：打硬仗（视频优化），扩地盘（文件/位置）。

---

## 1. 🚨 [P0] 核心战役：视频硬化 (Video Hardening)

**目标**：解决大文件 OOM、弱网失败、画质糊的问题。

### 🛠️ [P0-1] 智能加工逻辑 (Smart Video Processing)

* **按需压缩**：
* `> 1080p` 或 `> 24fps`：强制降级到 1080p/24fps，平衡体积。
* `Bitrate > 5Mbps`：强制压至 2-3Mbps（移动端黄金码率）。
* `< 10MB` 且符合标准：**跳过压缩**，直接进入 `UploadStep`，保留原生画质。


* **熔断机制**：在 `VideoProcessStep` 头部增加校验，禁止处理超过 500MB 的原始视频，弹出“文件过大”提示。

### 🛠️ [P0-2] 进度感官对齐 (Progress Synchronization)

* **双段进度**：修改 `PipelineContext` 增加 `progress` 字段。
* 0% - 30%：压缩进度。
* 30% - 100%：上传进度。


* **UI 映射**：消息气泡展示这个“合并进度”，解决“压缩时转圈没进度，上传时进度跳变”的感官 Bug。

---

## 2. 📂 [P1] 功能扩张：新消息类型 (New Feature Set)

**目标**：利用现有 Pipeline 框架，快速复刻成熟 IM 的功能。

### 🚧 [P1-1] 全能菜单 (Action Sheet / Plus Menu)

* **Grid 入口**：点击 `+` 弹出 4x2 的功能矩阵。
* **集成功能**：相册、拍照、视频、文件、地理位置。
* **动画逻辑**：底部滑出，支持主题换色。

### 🚧 [P1-2] 文件消息管道 (File Message Pipeline)

* **元数据提取**：引入 `file_picker`，提取文件名、后缀、物理大小。
* **管道重用**：
* `FilePersistStep`：文件落地到 `AssetManager` 的 `chat_files` 目录。
* `SyncStep`：meta 中存入文件后缀，UI 根据后缀（PDF/DOC/ZIP）渲染对应图标。


* **交互**：点击触发系统自带预览或 `open_file` 插件。

### 🚧 [P1-3] 位置消息 (Location Snapshot)

* **静态模式**：集成地图 SDK，发送时截取当前位置的静态图。
* **Sync 逻辑**：meta 记录 `lat`、`lng` 和 `address`。
* **跳转**：点击气泡弹出系统底层菜单，调用百度/高德/Google Map 进行导航。

---

## 3. ⚡ [P2] 性能进阶：极致流畅度 (Optimization)

**目标**：列表滚动不掉帧，头像秒开。

### 🛠️ 组合头像持久化 (Group Avatar Caching)

* **逻辑**：目前的九宫格头像是 Canvas 实时画的。改为画完后通过 `toByteData` 保存为本地 PNG 文件。
* **缓存策略**：数据库记录 `avatar_local_path`。
* **收益**：群聊列表滚动时，由“实时计算”变为“静态图加载”，性能提升 300%。

---

## 📝 接下来 48 小时执行指令

大哥，计划已经对齐，我们现在**先修内功**。

**第一步：升级 `VideoProcessor**`。
我要给它装上“智能码率探测”和“分级压缩”逻辑，防止它再把小视频压坏，或者让大视频把内存撑爆。

**如果同意，请指示，我立刻开始输出 `VideoProcessor` 的硬化代码！**