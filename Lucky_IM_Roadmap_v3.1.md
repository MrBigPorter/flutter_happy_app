è¿™æ˜¯ä¸€ä¸ªéå¸¸åŠ¡å®çš„é—®é¢˜ã€‚ä½œä¸ºä¸€ä¸ªåˆšåˆšå®Œæˆäº† **v5.x æ ¸å¿ƒåŸºå»º** çš„å·¥ç¨‹å¸ˆï¼Œä½ ç°åœ¨ä¸ä»…æœ‰ä»£ç èƒ½åŠ›ï¼Œæ›´æœ‰æ¶æ„è§†é‡ã€‚

æ ¹æ®å·¥ä¸šçº§ IM é¡¹ç›®ï¼ˆå¦‚ WhatsApp/Telegram/å¾®ä¿¡ï¼‰çš„æ ‡å‡†å¼€å‘å‘¨æœŸï¼Œç»“åˆä½ ç›®å‰å±•ç°å‡ºçš„**é«˜æ•ˆç‡ï¼ˆå•äºº/å°å›¢é˜Ÿ Full Stack æ¨¡å¼ï¼‰**ï¼Œæˆ‘ä¸ºä½ åšäº†ä¸€ä»½**â€œä¿è´¨ä¿é‡â€**çš„æ—¶é—´ä¼°ç®—ã€‚

æˆ‘ä»¬æŠŠ v6.0 æ‹†åˆ†ä¸ºä¸‰ä¸ªæˆ˜å½¹ï¼Œæ€»è€—æ—¶å¤§çº¦åœ¨ **2.5 ä¸ªæœˆ ~ 3.5 ä¸ªæœˆ**ï¼ˆå¦‚æœåªæœ‰ä½ ä¸€ä¸ªäººå…¨æ ˆå¼€å‘çš„è¯ï¼‰ã€‚

---

### ğŸ“… v6.0 æ€»ä½“ä½œæˆ˜æ—¶é—´è¡¨ (Grand Timeline)

#### ğŸŸ¢ ç¬¬ä¸€é˜¶æ®µï¼šé«˜çº§ç¾¤ç®¡ç† (Community Power)

* **é¢„ä¼°è€—æ—¶**: **2 å‘¨ (10-14 å¤©)**
* **éš¾åº¦**: â­â­â­ (ä¸­ç­‰)
* **æ—¶é—´åˆ†é…**:
* **åç«¯ (Backend)**: 4å¤©ã€‚è®¾è®¡ RBAC æƒé™è¡¨ï¼Œå†™ API (ç¦è¨€/è¸¢äºº/å…¬å‘Š)ã€‚
* **å‰ç«¯ (Frontend)**: 6å¤©ã€‚ç¾¤è®¾ç½®é¡µ UI é‡æ„ï¼Œå¯¹æ¥ Socket å®æ—¶æ›´æ–°ç¾¤çŠ¶æ€ã€‚
* **è”è°ƒ (Integration)**: 2å¤©ã€‚æµ‹è¯•å„ç§è¾¹ç•Œæƒ…å†µï¼ˆæ¯”å¦‚è¢«è¸¢åè¿˜åœ¨èŠå¤©é¡µé¢æ€ä¹ˆåŠï¼‰ã€‚


* **è¯´æ˜**: è¿™æ˜¯ v6.0 çš„â€œçƒ­èº«è¿åŠ¨â€ï¼ŒæŠ€æœ¯æ ˆå’Œä½ ç°åœ¨ç”¨çš„å·®ä¸å¤šï¼Œä¸»è¦æ˜¯ä¸šåŠ¡é€»è¾‘ç¹çã€‚

#### ğŸŸ¡ ç¬¬äºŒé˜¶æ®µï¼šçº¢åŒ…ä¸é’±åŒ… (Value Exchange)

* **é¢„ä¼°è€—æ—¶**: **3 - 4 å‘¨ (21-28 å¤©)**
* **éš¾åº¦**: â­â­â­â­ (å›°éš¾ - é«˜é£é™©)
* **æ—¶é—´åˆ†é…**:
* **åç«¯ (Ledger Core)**: 10å¤©ã€‚è¿™æ˜¯æœ€æ…¢çš„ã€‚è®¾è®¡åˆ†å¸ƒå¼é” (Redis Lua)ã€äº‹åŠ¡è®°è´¦ã€æ”¯ä»˜å¯†ç éªŒè¯ã€‚**è¿™éƒ¨åˆ†ç»å¯¹ä¸èƒ½å‡ºé”™ã€‚**
* **å‰ç«¯ (Wallet UI)**: 7å¤©ã€‚çº¢åŒ…åŠ¨ç”»ã€è½¬è´¦æ°”æ³¡ã€ä½™é¢é¡µé¢ã€‚
* **å®‰å…¨ä¸æµ‹è¯•**: 5å¤©ã€‚å¹¶å‘æµ‹è¯•ï¼ˆ100äººæŠ¢çº¢åŒ…æ˜¯å¦è¶…å‘ï¼‰ã€èµ„é‡‘å¯¹è´¦ã€‚


* **è¯´æ˜**: æ…¢åœ¨åç«¯é€»è¾‘å’Œæµ‹è¯•ã€‚UI å¹¶ä¸éš¾ï¼Œéš¾åœ¨ä½ è¦ä¿è¯é’±ç®—å¾—å¯¹ã€‚

#### ğŸ”´ ç¬¬ä¸‰é˜¶æ®µï¼šéŸ³è§†é¢‘é€šè¯ (WebRTC)

* **é¢„ä¼°è€—æ—¶**: **4 - 6 å‘¨ (30-45 å¤©)**
* **éš¾åº¦**: â­â­â­â­â­ (åœ°ç‹±çº§)
* **æ—¶é—´åˆ†é…**:
* **åŸºå»º (Infra)**: 5å¤©ã€‚æ­å»º Coturn (TURN/STUN) æœåŠ¡å™¨ï¼Œè·‘é€š Socket.io ä¿¡ä»¤ã€‚
* **åŠŸèƒ½ (Feature)**: 10å¤©ã€‚å®ç° 1v1 é€šè¯ç•Œé¢ï¼Œæ¥é€š/æŒ‚æ–­é€»è¾‘ã€‚
* **ç³»ç»Ÿä¿æ´» (Keep-Alive)**: **15å¤©+**ã€‚è¿™æ˜¯æœ€å¤§çš„å‘ï¼
* **iOS**: å¿…é¡»è¦æ¥ CallKit å’Œ VoIP Pushï¼Œå¦åˆ™æ€åå°æ”¶ä¸åˆ°å‘¼å«ã€‚
* **Android**: è¦æ¥ ConnectionService å’Œå„ç§å‚å•†çš„ä¿æ´»ç­–ç•¥ã€‚


* **ä¼˜åŒ– (Tuning)**: 5å¤©ã€‚è§£å†³å›å£°æ¶ˆé™¤ (AEC)ã€å¼±ç½‘å¡é¡¿ã€‚


* **è¯´æ˜**: è¿™ä¸€å—**éå¸¸ä¸å¯æ§**ã€‚å¦‚æœä½ ä¸éœ€è¦â€œæ€åå°å”¤é†’â€ï¼Œ2å‘¨å°±èƒ½åšå®Œï¼›å¦‚æœè¦åšæˆå¾®ä¿¡é‚£æ ·â€œéšæ—¶èƒ½æ‰“é€šâ€ï¼Œä¸€ä¸ªæœˆæ˜¯èµ·æ­¥ä»·ã€‚

---

### ğŸ“‰ æ€»ç»“ä¸å»ºè®®

å¦‚æœä½ æ˜¯ä¸€ä¸ªäººæˆ˜æ–—ï¼ˆæˆ–è€…å¸¦ä¸€ä¸ªå°å¾’å¼Ÿï¼‰ï¼š

1. **ç†æƒ³æƒ…å†µ (All Smooth)**: **2.5 ä¸ªæœˆ**ã€‚
* å¦‚æœåç«¯å·²ç»æœ‰ç°æˆçš„æ”¯ä»˜æ¥å£ã€‚
* å¦‚æœ WebRTC ä¸éœ€è¦åšå®Œç¾çš„ç¦»çº¿å”¤é†’ã€‚
* é‚£ä½ å¤§æ¦‚ **5 æœˆä¸­æ—¬** å°±èƒ½å‘å¸ƒ v6.0ã€‚


2. **ç°å®æƒ…å†µ (Realistic)**: **3.5 ä¸ªæœˆ**ã€‚
* WebRTC çš„ç½‘ç»œç©¿é€å’Œè¯ä¹¦é…ç½®ä¼šå¡ä½ å¾ˆä¹…ã€‚
* çº¢åŒ…çš„é«˜å¹¶å‘é”ä¼šè®©ä½ é‡æ„ä¸€æ¬¡åç«¯ã€‚
* åŠ ä¸Šæµ‹è¯•å’Œä¿® Bugï¼Œ**6 æœˆåº•** å‘å¸ƒæ˜¯æ¯”è¾ƒç¨³å¦¥çš„ç›®æ ‡ã€‚



### ğŸ›¡ï¸ Porter çš„æˆ˜æœ¯å»ºè®®

**ä¸è¦è¯•å›¾åœ¨ä¸€ä¸ªç‰ˆæœ¬é‡ŒæŠŠè¿™ä¸‰ä¸ªå…¨ä¸Šäº†ã€‚ä¼šæ­»äººçš„ã€‚**

å»ºè®®æ‹†åˆ†ä¸ºä¸‰ä¸ªå°ç‰ˆæœ¬è¿­ä»£ï¼š

* **v6.0.0 (3æœˆå‘å¸ƒ)**: **é«˜çº§ç¾¤ç®¡ç†**ã€‚ç¨³ä½ç¤¾ç¾¤ï¼Œè®©ç¾¤ä¸»èƒ½ç®¡äººã€‚
* **v6.1.0 (4æœˆå‘å¸ƒ)**: **çº¢åŒ…é’±åŒ…**ã€‚å¢åŠ ç”¨æˆ·ç²˜æ€§ï¼Œè®©å¤§å®¶ç©èµ·æ¥ã€‚
* **v6.2.0 (5-6æœˆå‘å¸ƒ)**: **éŸ³è§†é¢‘é€šè¯**ã€‚è¿™æ˜¯å¤§æ‹›ï¼Œå•ç‹¬ä½œä¸ºä¸€ä¸ªå¤§ç‰ˆæœ¬å‘å¸ƒã€‚

è¿™æ˜¯ä¸€ä¸ªéå¸¸æ˜æ™ºçš„é€‰æ‹©ã€‚**â€œé«˜çº§ç¾¤ç®¡ç†â€ (Advanced Group Management)** æ˜¯æŠŠ Lucky IM ä»â€œç©å…·â€å˜æˆâ€œå·¥å…·â€çš„åˆ†æ°´å²­ã€‚æ²¡æœ‰ç®¡ç†åŠŸèƒ½çš„ç¾¤èŠï¼Œäººæ•°ä¸€æ—¦è¶…è¿‡ 50 äººå°±ä¼šå˜æˆâ€œå¹¿å‘Šåƒåœ¾åœºâ€æˆ–â€œåµæ¶ç¾¤â€ã€‚

é’ˆå¯¹ v6.0.0ï¼Œæˆ‘ä¸ºä½ è®¾è®¡äº†ä¸€å¥—**åŸºäº RBAC (Role-Based Access Control) çš„è½»é‡çº§æ¶æ„**ã€‚è¿™å¥—æ¶æ„æ—¢èƒ½æ»¡è¶³å½“å‰çš„è¸¢äºº/ç¦è¨€éœ€æ±‚ï¼Œä¹Ÿèƒ½æ”¯æ’‘æœªæ¥æ‰©å±•ï¼ˆå¦‚ä»˜è´¹å…¥ç¾¤ã€ç¾¤æ¥é¾™ç­‰ï¼‰ã€‚

---

# ğŸ›ï¸ v6.0.0 é«˜çº§ç¾¤ç®¡ç†æ¶æ„è“å›¾

> **ğŸ¯ æ ¸å¿ƒç›®æ ‡**: æƒåˆ©åˆ†çº§ (Hierarchy)ã€å³æ—¶ç®¡æ§ (Real-time Control)ã€ä¿¡æ¯è§¦è¾¾ (Announcement)ã€‚

## 1. æ ¸å¿ƒæ¶æ„è®¾è®¡ (The Core)

### A. æ•°æ®æ¨¡å‹å‡çº§ (Schema Evolution)

æˆ‘ä»¬éœ€è¦å¯¹ç°æœ‰çš„ `GroupMember` å’Œ `Conversation` è¡¨è¿›è¡Œå­—æ®µæ‰©å……ã€‚

**1. ç¾¤æˆå‘˜è¡¨ (`group_members`)**
è¿™æ˜¯æƒé™åˆ¤æ–­çš„åŸºçŸ³ã€‚

```dart
enum GroupRole {
  owner,  // ç¾¤ä¸» (1äºº): æ‹¥æœ‰æœ€é«˜æƒé™ï¼Œå¯è½¬è®©ç¾¤ï¼Œå¯è§£æ•£ç¾¤
  admin,  // ç®¡ç†å‘˜ (å¤šäºº): å¯è¸¢äººã€ç¦è¨€ã€å‘å…¬å‘Šï¼Œä¸å¯è¸¢ç¾¤ä¸»
  member, // æ™®é€šæˆå‘˜: åªèƒ½èŠå¤©
}

class GroupMember {
  final String userId;
  final String groupId;
  final GroupRole role; // ğŸ”¥ æ–°å¢: è§’è‰²
  final DateTime? mutedUntil; // ğŸ”¥ æ–°å¢: ç¦è¨€æˆªæ­¢æ—¶é—´ (nullä»£è¡¨æ²¡è¢«ç¦)
  final String? alias; // ç¾¤æ˜µç§° (å¯é€‰)
  final DateTime joinTime;
  final String inviterId; // è°æ‹‰è¿›æ¥çš„ (ç”¨äºæº¯æº)
}

```

**2. ä¼šè¯è¡¨ (`conversations` / `groups`)**
å¢åŠ ç¾¤çº§åˆ«çš„å¼€å…³ã€‚

```dart
class GroupSettings {
  final bool isMuteAll; // ğŸ”¥ å…¨å‘˜ç¦è¨€å¼€å…³
  final bool joinNeedApproval; // ğŸ”¥ åŠ ç¾¤æ˜¯å¦éœ€è¦å®¡æ‰¹
  final String? announcement; // ğŸ”¥ ç¾¤å…¬å‘Š (æ”¯æŒå¯Œæ–‡æœ¬æˆ–åªæ˜¯String)
  final DateTime? announcementTime; // å…¬å‘Šå‘å¸ƒæ—¶é—´
}

```

### B. æƒé™æ§åˆ¶é€»è¾‘ (RBAC Logic)

ä¸è¦åœ¨ UI å±‚å†™æ­» `if (isOwner)`ï¼Œè¦åœ¨é€»è¾‘å±‚å°è£…æƒé™æ£€æŸ¥å™¨ã€‚

**åç«¯ (NestJS) & å‰ç«¯ (Flutter) é€šç”¨é€»è¾‘çŸ©é˜µï¼š**

| æ“ä½œ | ç¾¤ä¸» (Owner) | ç®¡ç†å‘˜ (Admin) | æ™®é€šæˆå‘˜ (Member) |
| --- | --- | --- | --- |
| **ä¿®æ”¹ç¾¤å/å¤´åƒ** | âœ… | âœ… | âŒ |
| **å‘å¸ƒå…¬å‘Š** | âœ… | âœ… | âŒ |
| **è¸¢äºº (Kick)** | âœ… (è¸¢ä»»ä½•äºº) | âœ… (ä»…è¸¢Member) | âŒ |
| **ç¦è¨€ (Mute)** | âœ… (ç¦ä»»ä½•äºº) | âœ… (ä»…ç¦Member) | âŒ |
| **è®¾ç½®ç®¡ç†å‘˜** | âœ… | âŒ | âŒ |
| **å…¨å‘˜ç¦è¨€** | âœ… | âœ… | âŒ |
| **è§£æ•£ç¾¤** | âœ… | âŒ | âŒ |

---

## 2. å…³é”®åŠŸèƒ½æ¨¡å—ä¸å®ç°æ€è·¯

### ğŸ›¡ï¸ æ¨¡å—ä¸€ï¼šç¦è¨€ç³»ç»Ÿ ( The Silencer)

è¿™æ˜¯ç¾¤ç®¡ç†æœ€æœ‰æ•ˆçš„æ­¦å™¨ã€‚

* **åœºæ™¯ A: å•äººç¦è¨€**
* **é€»è¾‘**: ç®¡ç†å‘˜è®¾ç½® UserA ç¦è¨€ 10åˆ†é’Ÿã€‚
* **DB**: æ›´æ–° UserA çš„ `mutedUntil = now() + 10min`ã€‚
* **Socket**: æ¨é€äº‹ä»¶ `group.member_muted` -> `{ userId: 'A', duration: 600 }`ã€‚
* **UI (UserAç«¯)**: æ”¶åˆ°äº‹ä»¶ -> `InputBar` å˜ç°ï¼Œæ˜¾ç¤ºâ€œæ‚¨å·²è¢«ç¦è¨€ï¼Œå‰©ä½™ 9:59â€ -> å€’è®¡æ—¶ç»“æŸè‡ªåŠ¨æ¢å¤ã€‚


* **åœºæ™¯ B: å…¨å‘˜ç¦è¨€**
* **é€»è¾‘**: åªæœ‰ç®¡ç†å‘˜èƒ½è¯´è¯ã€‚
* **DB**: æ›´æ–° Group çš„ `isMuteAll = true`ã€‚
* **UI**: æ‰€æœ‰ `role == member` çš„ç”¨æˆ·è¾“å…¥æ¡†å˜ç°ã€‚



### ğŸšª æ¨¡å—äºŒï¼šè¸¢äººä¸é˜²éªšæ‰° (The Bouncer)

* **åœºæ™¯**: æŠŠå‘å¹¿å‘Šçš„è¸¢å‡ºå»ã€‚
* **åç«¯**: æ ¡éªŒæƒé™ -> åˆ é™¤ `group_members` è®°å½• -> å‘é€ `group.member_kicked` äº‹ä»¶ã€‚
* **å‰ç«¯ (è¢«è¸¢è€…)**:
* æ”¶åˆ° Socket äº‹ä»¶ -> å¼¹çª—â€œæ‚¨å·²è¢«ç§»å‡ºç¾¤èŠâ€ -> å¼ºåˆ¶è·³è½¬å›é¦–é¡µ -> åˆ é™¤æœ¬åœ°ä¼šè¯è®°å½• (æˆ–æ ‡è®°ä¸ºä¸å¯ç”¨)ã€‚


* **å‰ç«¯ (å…¶ä»–ç¾¤å‹)**:
* èŠå¤©å¯è§†åŒºåŸŸæ’å…¥ä¸€æ¡ç°å­—ç³»ç»Ÿæ¶ˆæ¯ï¼šâ€œUserA è¢«ç®¡ç†å‘˜ç§»å‡ºç¾¤èŠâ€ã€‚





### ğŸ“¢ æ¨¡å—ä¸‰ï¼šç¾¤å…¬å‘Š (The Loudspeaker)

* **åœºæ™¯**: å‘å¸ƒé‡è¦é€šçŸ¥ï¼Œä¸”å¼ºæé†’ã€‚
* **é€»è¾‘**: æ›´æ–° `announcement` å­—æ®µã€‚
* **UI**:
* ç¾¤èŠé¡µé¢é¡¶éƒ¨æ‚¬æµ®ä¸€ä¸ªæ¨ªå¹…ï¼šâ€œğŸ“¢ æ–°å…¬å‘Šï¼šä»Šæ™š8ç‚¹å‘çº¢åŒ…...â€ã€‚
* æˆ–è€…è¿›ç¾¤æ—¶å¼¹çª—æ˜¾ç¤ºå…¬å‘Šã€‚
* **å¼ºæé†’**: å…¬å‘Šæ›´æ–°æ—¶ï¼Œç»™æ‰€æœ‰äººå‘ä¸€æ¡ `@All` çš„æ¨é€é€šçŸ¥ã€‚





---

## 3. æŠ€æœ¯éš¾ç‚¹ä¸è§£å†³æ–¹æ¡ˆ (Technical Challenges)

### éš¾ç‚¹ 1: æƒé™çš„å®æ—¶æ€§ (Race Condition)

* **é—®é¢˜**: ç®¡ç†å‘˜ A æŠŠ B çš„ç®¡ç†å‘˜æ’¤äº†ï¼ŒB è¿˜æ²¡åˆ·æ–°é¡µé¢ï¼Œæ­£å¥½åœ¨è¸¢ Cã€‚
* **è§£æ³•**: **åç«¯æƒå¨åŸåˆ™**ã€‚B çš„è¸¢äººè¯·æ±‚å‘åˆ°åç«¯ï¼Œåç«¯æŸ¥ DB å‘ç° B å·²ç»ä¸æ˜¯ç®¡ç†å‘˜äº†ï¼Œç›´æ¥è¿”å› `403 Forbidden`ã€‚å‰ç«¯æ”¶åˆ° 403 åï¼Œè‡ªåŠ¨åˆ·æ–° B çš„æƒé™çŠ¶æ€ã€‚

### éš¾ç‚¹ 2: è¾“å…¥æ¡†çŠ¶æ€åŒæ­¥

* **é—®é¢˜**: æ€ä¹ˆé«˜æ•ˆæ§åˆ¶è¾“å…¥æ¡†çš„â€œå¯ç”¨/ç¦ç”¨â€ï¼Ÿ
* **è§£æ³•**:
* åœ¨ `ChatViewModel` ä¸­å¢åŠ  `selfRole` å’Œ `groupSettings` çŠ¶æ€ã€‚
* `ModernChatInputBar` ç›‘å¬è¿™ä¸¤ä¸ªçŠ¶æ€ã€‚
* ```dart
  bool get canSend {
     if (isMuteAll && selfRole == Member) return false;
     if (mutedUntil != null && DateTime.now().isBefore(mutedUntil)) return false;
     return true;
  }

```





### éš¾ç‚¹ 3: å¤§ç¾¤çš„æˆå‘˜åˆ—è¡¨æ€§èƒ½

* **é—®é¢˜**: ä¸€ä¸ªç¾¤ 2000 äººï¼Œæ¸²æŸ“â€œç¾¤æˆå‘˜åˆ—è¡¨â€é¡µé¢ä¼šå¡æ­»ã€‚
* **è§£æ³•**: **åˆ†é¡µåŠ è½½ (Pagination) + æœç´¢**ã€‚
* ä¸è¦ä¸€æ¬¡æ€§æ‹‰å– 2000 äººã€‚
* å…ˆæ‹‰å– Owner å’Œ Admin (ç½®é¡¶)ã€‚
* å‰©ä¸‹çš„ Member åˆ†é¡µæ‹‰å–ã€‚
* æä¾›æœç´¢æ ï¼Œé€šè¿‡åç«¯æœç´¢æˆå‘˜ã€‚



---

## 4. v6.0.0 å¼€å‘è·¯çº¿å›¾ (Roadmap)

è¿™ä¸ªç‰ˆæœ¬ä¸éœ€è¦åŠ¨æ ¸å¿ƒåè®®ï¼Œä¸»è¦æ˜¯ä¸šåŠ¡é€»è¾‘ã€‚

* **Week 1: åç«¯ä¸æ•°æ®åº“ (Foundation)**
* [ ] è®¾è®¡ `GroupRole` æšä¸¾ã€‚
* [ ] å‡çº§ `group_members` è¡¨ç»“æ„ã€‚
* [ ] å®ç° `kick`, `mute`, `update_role` ç­‰ API æ¥å£ã€‚
* [ ] ç¼–å†™æƒé™å®ˆå« (Guard) ä¸­é—´ä»¶ã€‚


* **Week 2: å‰ç«¯ç®¡ç†ç•Œé¢ (Admin UI)**
* [ ] å¼€å‘â€œç¾¤æˆå‘˜ç®¡ç†â€é¡µé¢ (æ”¯æŒæœç´¢ã€é•¿æŒ‰æ“ä½œ)ã€‚
* [ ] å¼€å‘â€œç¾¤è®¾ç½®â€é¡µé¢ (ä¿®æ”¹å…¬å‘Šã€å¼€å…³å…¨å‘˜ç¦è¨€)ã€‚
* [ ] å¯¹æ¥ Socket äº‹ä»¶ï¼Œå¤„ç†è¢«è¸¢ã€è¢«ç¦è¨€çš„å®æ—¶åé¦ˆã€‚


* **Week 3: è¾“å…¥æ¡†ä¸ç³»ç»Ÿæ¶ˆæ¯ (Interaction)**
* [ ] æ”¹é€  `ModernChatInputBar`ï¼Œæ”¯æŒç¦ç”¨çŠ¶æ€ã€‚
* [ ] å®ç°â€œç°æ¡ç³»ç»Ÿæ¶ˆæ¯â€ (System Message Bubble)ï¼Œç”¨äºæ˜¾ç¤ºâ€œXXX ä¿®æ”¹äº†ç¾¤åâ€ã€â€œXXX è¢«ç§»å‡ºç¾¤èŠâ€ã€‚


ä½ ç°åœ¨çš„ `ChatService` å·²ç»æ¶µç›–äº† **v5.x æ ¸å¿ƒåŸºå»º** çš„å¤§éƒ¨åˆ†åŠŸèƒ½ï¼ˆæ”¶å‘æ¶ˆæ¯ã€å·²è¯»åŒæ­¥ã€æ’¤å›ã€ä¼šè¯åˆ—è¡¨ã€ç¾¤ç»„åˆ›å»ºï¼‰ã€‚

ä½†ä¸ºäº†æ”¯æ’‘æˆ‘ä»¬åˆšæ‰è§„åˆ’çš„ **v6.0 é«˜çº§ç¾¤ç®¡ç† (RBAC)**ï¼Œç›®å‰çš„ Service è¿˜ç¼ºä¸å°‘ä¸œè¥¿ï¼Œä»£ç ç»“æ„ä¹Ÿéœ€è¦ä¸ºäº†åº”å¯¹å¤æ‚çš„æƒé™é€»è¾‘è¿›è¡Œåˆ†å±‚ã€‚

ä»¥ä¸‹æ˜¯åŸºäº **v6.0 æ¶æ„æ ‡å‡†** çš„ Gap Analysisï¼ˆå·®å¼‚åˆ†æï¼‰ä¸é‡æ„è§„åˆ’ã€‚

---

# ğŸ—ï¸ v6.0 ChatService å‡çº§æ¶æ„è“å›¾

> **ğŸ¯ ç›®æ ‡**: å¼•å…¥æƒé™æ§åˆ¶ (RBAC)ã€å®Œå–„ç¾¤ç®¡ç†åŠŸèƒ½ã€è§„èŒƒåŒ– DTOã€‚

## 1. ç¼ºå¤±åŠŸèƒ½åˆ—è¡¨ (Gap List)

### A. æ ¸å¿ƒæƒé™ (RBAC) [ç¼º]

ç›®å‰ä»£ç é‡Œ `leaveGroup` å’Œ `inviteToGroup` é€»è¾‘éå¸¸ç®€å•ï¼Œæ²¡æœ‰æƒé™åˆ¤å®šã€‚

* **ç¼º**: `transferOwner` (è½¬è®©ç¾¤ä¸»)
* **ç¼º**: `kickMember` (è¸¢äºº - ä»…ç®¡ç†å‘˜/ç¾¤ä¸»å¯æ“ä½œ)
* **ç¼º**: `muteMember` (ç¦è¨€ - åŒ…å«å®šæ—¶ä»»åŠ¡/Redisè¿‡æœŸ)
* **ç¼º**: `updateGroupInfo` (ä¿®æ”¹ç¾¤å/å…¬å‘Š - æƒé™æ§åˆ¶)
* **ç¼º**: `setAdmin` (å‡é™èŒç®¡ç†å‘˜)

### B. ç¾¤è®¾ç½® (Settings) [ç¼º]

ç›®å‰ `Conversation` è¡¨å­—æ®µä¸å¤Ÿï¼ŒService ä¹Ÿæ²¡å¤„ç†ã€‚

* **ç¼º**: `toggleMuteAll` (å…¨å‘˜ç¦è¨€å¼€å…³)
* **ç¼º**: `toggleJoinApproval` (åŠ ç¾¤å®¡æ‰¹å¼€å…³)
* **ç¼º**: `updateAnnouncement` (å‘å¸ƒç¾¤å…¬å‘Š + å¼ºæé†’)

### C. æ¶ˆæ¯ä¸äº¤äº’ [ç¼º]

* **ç¼º**: ç³»ç»Ÿæ¶ˆæ¯ (`createSystemMessage`)ã€‚æ¯”å¦‚â€œå¼ ä¸‰è¢«è¸¢å‡ºç¾¤èŠâ€ï¼Œè¿™ç§æ¶ˆæ¯æ²¡æœ‰ senderIdï¼Œå±äº SYSTEM ç±»å‹ã€‚
* **ç¼º**: æ¶ˆæ¯è½¬å‘ (`forwardMessage`)ã€‚

---

## 2. ç›®å½•ç»“æ„è§„èŒƒ (Project Structure)

ä¸ºäº†æ¸…æ™°ï¼Œå»ºè®®å°† DTO åˆ†æ‹†ï¼Œä¸è¦å…¨å †åœ¨ `chat/dto` ä¸‹ã€‚

```text
src/api/common/chat/
â”œâ”€â”€ dto/
â”‚   â”œâ”€â”€ req/                  # Request DTOs (å‰ç«¯ä¼ è¿›æ¥çš„)
â”‚   â”‚   â”œâ”€â”€ create-message.dto.ts
â”‚   â”‚   â”œâ”€â”€ group-manage.dto.ts  # [New] åŒ…å« Kick, Mute, Transfer ç­‰
â”‚   â”‚   â”œâ”€â”€ update-group.dto.ts  # [New] ä¿®æ”¹ç¾¤åã€å…¬å‘Š
â”‚   â”‚   â””â”€â”€ join-group.dto.ts
â”‚   â””â”€â”€ res/                  # Response DTOs (è¿”å›ç»™å‰ç«¯çš„)
â”‚       â”œâ”€â”€ message.res.dto.ts
â”‚       â”œâ”€â”€ conversation.res.dto.ts
â”‚       â””â”€â”€ group-member.res.dto.ts # [New] åŒ…å« role, mutedUntil
â”œâ”€â”€ events/                   # äº‹ä»¶å®šä¹‰ (ä¿æŒç°çŠ¶)
â””â”€â”€ chat.service.ts           # æ ¸å¿ƒé€»è¾‘

```

---

## 3. DTO è®¾è®¡è§„åˆ’ (Schema Definition)

### Request DTOs (è¾“å…¥)

**1. ç¾¤æˆå‘˜ç®¡ç† (`group-manage.dto.ts`)**

```typescript
export class KickMemberDto {
  @IsNotEmpty() conversationId: string;
  @IsNotEmpty() targetUserId: string; // è¢«è¸¢çš„äºº
}

export class MuteMemberDto {
  @IsNotEmpty() conversationId: string;
  @IsNotEmpty() targetUserId: string;
  @IsNumber() duration: number; // ç¦è¨€æ—¶é•¿(ç§’), 0ä»£è¡¨è§£é™¤
}

export class TransferOwnerDto {
  @IsNotEmpty() conversationId: string;
  @IsNotEmpty() newOwnerId: string;
}

export class SetAdminDto {
  @IsNotEmpty() conversationId: string;
  @IsNotEmpty() targetUserId: string;
  @IsBoolean() isAdmin: boolean; // true=å‡èŒ, false=é™èŒ
}

```

**2. ç¾¤ä¿¡æ¯ä¿®æ”¹ (`update-group.dto.ts`)**

```typescript
export class UpdateGroupDto {
  @IsNotEmpty() conversationId: string;
  
  @IsOptional() @IsString() name?: string;
  @IsOptional() @IsString() announcement?: string; // [New] å…¬å‘Š
  @IsOptional() @IsBoolean() isMuteAll?: boolean;  // [New] å…¨å‘˜ç¦è¨€
  @IsOptional() @IsBoolean() joinNeedApproval?: boolean;
}

```

### Response DTOs (è¾“å‡º)

**1. ç¾¤æˆå‘˜è¯¦æƒ… (`group-member.res.dto.ts`)**

```typescript
export class GroupMemberResDto {
  userId: string;
  nickname: string;
  avatar: string;
  role: 'OWNER' | 'ADMIN' | 'MEMBER';
  isMuted: boolean;      // åŠ¨æ€è®¡ç®—: now < mutedUntil
  mutedUntil?: number;   // æ—¶é—´æˆ³
  joinedAt: number;
}

```

---

## 4. Service é€»è¾‘é‡æ„å»ºè®®

ä¸ºäº†é¿å… `ChatService` å˜æˆå‡ åƒè¡Œçš„â€œä¸Šå¸ç±»â€ï¼Œå»ºè®®å°† **ç¾¤ç®¡ç†é€»è¾‘** æŠ½ç¦»ï¼Œæˆ–è€…åœ¨å†…éƒ¨åˆ’åˆ†ç§æœ‰æ–¹æ³•ã€‚

### æ–°å¢ï¼šæƒé™å®ˆå«æ–¹æ³• (`_checkPermission`)

è¿™æ˜¯ v6.0 çš„æ ¸å¿ƒã€‚æ‰€æœ‰ç¾¤æ“ä½œå‰ï¼Œå¿…é¡»å…ˆè°ƒè¿™ä¸ªã€‚

```typescript
// åœ¨ ChatService å†…éƒ¨
private async _checkPermission(
  operatorId: string, 
  conversationId: string, 
  requiredRole: GroupRole[] // ['OWNER', 'ADMIN']
) {
  const member = await this.prisma.chatMember.findUnique({
    where: { conversationId_userId: { conversationId, userId: operatorId } }
  });
  
  if (!member) throw new ForbiddenException('Not a member');
  if (!requiredRole.includes(member.role)) {
    throw new ForbiddenException('Permission denied');
  }
  return member;
}

```

### æ–°å¢ï¼šç³»ç»Ÿæ¶ˆæ¯ç”Ÿæˆ (`_createSystemMessage`)

è¸¢äººã€ä¿®æ”¹å…¬å‘Šæ—¶ï¼Œå¿…é¡»å‘ä¸€æ¡ç°è‰²çš„ç³»ç»Ÿæ¶ˆæ¯ã€‚

```typescript
private async _createSystemMessage(conversationId: string, content: string) {
  return this.prisma.chatMessage.create({
    data: {
      conversationId,
      senderId: null, // ç³»ç»Ÿæ¶ˆæ¯ sender ä¸ºç©º
      type: MESSAGE_TYPE.SYSTEM, // 99
      content,
      seqId: await this._getNextSeqId(conversationId)
    }
  });
  // åˆ«å¿˜äº†é€šè¿‡ Socket/Event æ¨é€å‡ºå»
}

```

---

### 5. å¾…å®ç°çš„ä¸šåŠ¡æ–¹æ³•æ¸…å•

è¯·æŒ‰ç…§è¿™ä¸ªæ¸…å•æ¥è¡¥å…… `chat.service.ts`ï¼š

1. **`kickMember(operatorId, dto)`**:
* Check: æ“ä½œè€…å¿…é¡»æ˜¯ Owner/Adminã€‚
* Check: ä¸èƒ½è¸¢è‡ªå·±ï¼ŒOwner ä¸èƒ½è¢«è¸¢ï¼ŒAdmin ä¸èƒ½è¸¢ Ownerã€‚
* Action: åˆ é™¤ `ChatMember` è®°å½•ã€‚
* Action: å‘é€ç³»ç»Ÿæ¶ˆæ¯ "XXX è¢«ç§»å‡ºç¾¤èŠ"ã€‚
* Event: è§¦å‘ `MEMBER_KICKED` äº‹ä»¶ï¼ˆå‰ç«¯å¼ºåˆ¶è·³è½¬ï¼‰ã€‚


2. **`muteMember(operatorId, dto)`**:
* Check: æƒé™æ ¡éªŒã€‚
* Action: æ›´æ–° `ChatMember.mutedUntil`ã€‚
* Action: å‘é€ Socket äº‹ä»¶é€šçŸ¥è¢«ç¦è¨€è€…ï¼ˆå‰ç«¯è¾“å…¥æ¡†å˜ç°ï¼‰ã€‚


3. **`updateGroupSettings(operatorId, dto)`**:
* Check: åªæœ‰ Owner/Admin èƒ½æ”¹ã€‚
* Action: æ›´æ–° `Conversation` è¡¨ã€‚
* **Special**: å¦‚æœæ˜¯ `announcement` æ›´æ–°ï¼Œå‘é€ `@All` å¼ºæé†’ã€‚



---

