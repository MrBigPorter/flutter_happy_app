明白，收到指令。

根据我们已经完成的代码部署（数据库初始化架构、本地全文检索、网络搜索 UI、好友闭环），**“本地全文检索”** 和 **“网络搜索”** 这两个高难度据点实际上已经被攻下。

这是为你刷新后的 **v5.1 核心架构净网战术板 (Sanitized Battle Plan)**。剔除了所有已完成项，只保留当下必须攻克的硬骨头。

---

# ⚔️ Lucky IM v5.1 核心架构剩余战术板 (The Remains)

> **🎯 当前阶段**: 骨架已成，开始注入灵魂（实时性与离线触达）。
> **🔥 聚焦重点**: **消息推送 (FCM)** 与 **增量同步 (SeqId)**。

## 🗺️ 剩余作战地图 (The Hardcore Remains)

### 🔴 P0: 核心数据同步与触达 (The Pulse)

*这是让 App 从“能用”变成“好用”的生死线。*

1. **消息推送 (FCM / APNs)** [Immediate Next]
* **目标**: App 杀进程后，通过系统通道唤醒，点击通知跳转对应聊天。
* **动作**: 集成 `firebase_messaging`，处理 Background Handler，实现 `getInitialMessage` 路由跳转。


2. **增量同步协议 (Incremental Sync / SeqId)**
* **目标**: 彻底消灭 `page=1` 的全量拉取，实现毫秒级差量同步。
* **动作**: 维护 `last_seq_id`，重构拉取逻辑为 `sync(since: seqId)`。


3. **Socket 断线重连补洞**
* **目标**: 网络波动后，自动补齐断线期间丢失的消息。



### 🟠 P1: 体验与交互打磨 (UX Polish)

*消除最后的“顿挫感”。*

1. **资源预热调度器 (Resource Scheduler)**
* **目标**: 列表快速滑动“零白块”。
* **动作**: 识别 Scroll `Idle` 状态，预加载屏幕外图片。


2. **发送消息乐观 UI (Optimistic Send)**
* **目标**: 发送瞬间上屏，不转圈，后台静默上传，失败才提示。
* **动作**: 引入 `tempId` 机制，失败回滚。


3. **Hero 无缝转场**
* **目标**: 头像/图片在页面间平滑飞入。



---

## 🚀 即刻执行指令 (Immediate Action)

既然**社交关系链**（找人、加人、本地搜人）的代码已经就绪，现在的首要任务是**打通“离线触达”**。如果用户杀掉 App 就收不到消息，IM 就没有灵魂。

**我们下一步攻克：P0 - 消息推送 (FCM) 与 路由唤醒**

### 🛠️ Track D-1: FCM 推送集成执行路线

1. **配置层**: 确保 `firebase_messaging` 依赖就位，`main.dart` 后台 Handler 注册无误。
2. **交互层**:
* **前台**: `RadixToast` 顶部通知。
* **后台**: 系统通知栏展示。


3. **路由层**: 点击通知 -> 识别 `type` -> 自动跳进 `ChatPage` 或 `NewFriendPage`。

**准备好了吗？我们开始搞 FCM！**