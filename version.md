

# 🏰 Lucky IM 架构现状与 v5.1 战略规划 (The Real Status)

> **🕒 状态快照**: 2026-02-03
> **🚀 核心评价**: 基建扎实，性能已止血，社交关系链初具雏形，但**数据同步机制**与**搜索能力**仍处于原始阶段。

## Ⅰ. 项目现状：我们拥有什么？(The Assets)

经过 v5.0.0 的清洗，现在的 Lucky IM 拥有以下**工业级**的核心资产：

### 1. 稳健的通信中枢 (`SocketService`) ✅

* **能力**: 采用 Mixin 架构解耦业务，具备完整的心跳保活、断线重连、Token 自动刷新。
* **价值**: 这是 IM 的心脏，目前运行稳定。

### 2. 强大的消息管道 (Pipeline Architecture) ✅

* **能力**: `Context -> Persist -> Process -> Upload -> Sync` 五步流水线。
* **覆盖**: 图片（压缩）、视频（封面截取+流式上传）、语音（波形图）、文件（图标映射）、位置（权限+地图）。
* **价值**: 极具扩展性，新增消息类型只需写一个 Step。

### 3. 离线保障体系 (`OfflineQueue`) ✅

* **能力**: 全局单例自动重发，网络恢复自动冲刷 Pending 队列。
* **价值**: 保证了“消息不丢”的底线。

### 4. 优秀的列表体验 (Silent Refresh) ✅

* **能力**: `ConversationList` 实现了 **SWR (Stale-While-Revalidate)** 策略。
* **价值**: 彻底告别了“下拉刷新白屏闪烁”，列表更新如丝般顺滑。

### 5. 专业的通讯录 UI (Contacts UI) ✅

* **能力**: **A-Z 索引** + **悬浮表头** + **侧边栏震动** + **毛玻璃气泡**。
* **价值**: 视觉和交互已经达到微信/iOS 原生通讯录的水准。

---

## Ⅱ. 核心痛点：我们缺失什么？(The Missing Pieces)

虽然 UI 和 基础收发 已经很强，但**深水区**的问题依然存在：

1. **数据同步依然原始 (The Sync Problem)** 🔴 **[Critical]**
* **现状**: 列表刷新还在用 `page=1` 的全量/分页拉取接口。
* **后果**: 数据量大时浪费流量，且无法精准感知“谁撤回了”、“谁改名了”。
* **解法**: 必须进化到 **SeqId 增量同步**。


2. **搜索能力缺失 (The Search Void)** 🔴 **[Critical]**
* **现状**: 通讯录虽然有 A-Z 排序，但顶部的搜索框是装饰品，无法搜索联系人或聊天记录。
* **后果**: 好友超过 50 人后，找人变得极其困难。
* **解法**: 必须引入 **本地全文检索 (Local FTS)**。


3. **离线触达断层 (The Reach Gap)** 🟠 **[Major]**
* **现状**: App 杀进程后，完全收不到消息（FCM 尚未集成）。
* **后果**: 用户不敢关 App，严重影响留存。
* **解法**: 必须集成 **FCM / APNs 推送**。



---

## Ⅲ. v5.1 战略规划 (The Battle Plan)

基于上述痛点，制定 **v5.1** 的核心作战目标：**“注入灵魂 (Soul Injection)”** —— 即**数据流**与**触达**。

### 🚀 第一战场：核心数据同步 (The Pulse)

**目标**: 彻底消灭 `page=1`，实现毫秒级差量同步。

1. **增量同步协议 (Incremental Sync / SeqId)**
* **动作**: 后端实现 Global SeqId，前端维护 `last_seq_id`，重构拉取逻辑为 `sync(since: seqId)`。


2. **Socket 断线重连补洞**
* **动作**: 网络波动恢复后，自动触发一次增量同步，补齐断线期间的消息。



### 🔍 第二战场：搜索与触达 (Reach & Search)

**目标**: 让用户找得到人，让消息找得到用户。

1. **消息推送 (FCM / APNs)**
* **动作**: 集成 `firebase_messaging`，打通系统级通知通道，实现点击跳转路由。


2. **本地全文检索 (Local FTS)**
* **动作**: 基于 Sembast/Isar 建立倒排索引，实现对联系人昵称、聊天记录的毫秒级检索。



### 🛠️ 第三战场：体验打磨 (Polish)

1. **资源预热 (Pre-warming)**
* **动作**: 监听 Scroll Idle 状态，预加载屏幕外图片，消灭滑动白块。


2. **乐观发送 (Optimistic UI)**
* **动作**: 进一步优化发送体验，实现建群/加好友等操作的“先变 UI，后调接口”。



---

## 🛑 总结 (Executive Summary)

* **已完成 (Done)**: UI 架构、消息管道、离线队列、列表静默刷新、通讯录索引 UI。
* **下一步 (Next)**: **FCM 推送** (让 App 活着) -> **增量同步** (让数据变快) -> **本地搜索** (让内容可查)。

**Ready for v5.1?** 让我们开始攻克 FCM！